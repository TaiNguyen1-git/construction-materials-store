// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Banner Management
model Banner {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  imageUrl    String
  tag         String?
  link        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("banners")
  @@index([isActive])
  @@index([order])
}

// System Announcements (Maintenance, Features, Alerts)
model SystemAnnouncement {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  content     String
  type        AnnouncementType @default(INFO) // MAINTENANCE, FEATURE, POLICY, INFO
  targetRole  UserRole? // NULL = All, or specific role
  targetPath  String?   // NULL = Global, or specific path like '/market', '/admin/orders'
  displayMode DisplayMode @default(MODAL)
  imageUrl    String?
  actionLabel String?
  actionUrl   String?
  isActive    Boolean  @default(true)
  startTime   DateTime @default(now())
  endTime     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_announcements")
  @@index([isActive])
  @@index([startTime, endTime])
  announcementActions UserAnnouncementAction[]
}

enum DisplayMode {
  MODAL
  BANNER
}

model UserAnnouncementAction {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  announcementId  String   @db.ObjectId
  action          String   // SEEN, ACCEPTED, DISMISSED
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id])
  announcement    SystemAnnouncement @relation(fields: [announcementId], references: [id])

  @@unique([userId, announcementId])
  @@map("user_announcement_actions")
}

enum AnnouncementType {
  MAINTENANCE
  FEATURE
  POLICY
  INFO
  DEBT_LOCK
}

// User Management
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  name      String
  password  String
  role      UserRole @default(CUSTOMER)
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Password reset & OTP
  resetToken       String?
  resetTokenExpiry DateTime?
  mustChangePassword Boolean @default(false)
  
  // Verification & 2FA
  emailVerified    Boolean   @default(false)
  otpCode          String?
  otpExpiresAt     DateTime?
  is2FAEnabled     Boolean   @default(false)
  hasSetTwoFactor  Boolean   @default(false)
  twoFactorSecret  String?   // TOTP secret for 2FA

  // Relationships
  employee Employee?
  customer Customer?
  announcementActions UserAnnouncementAction[]
  notifications       Notification[]
  disputeComments     DisputeComment[]
  pushSubscriptions   UserPushSubscription[]

  @@map("users")
  @@index([role])
  supplier      Supplier?
  sessions UserSession[]
  organizationMemberships OrganizationMember[]
  sentInvitations         OrganizationInvitation[]
}

// User Session Management (for multi-device/tab support)
model UserSession {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  tokenHash    String   // Hash of the JWT token (for revocation)
  deviceInfo   String?  // Browser/device info
  ipAddress    String?  // IP address
  userAgent    String?  // User agent string
  tabId        String?  // Tab identifier for multi-tab support
  isActive     Boolean  @default(true)
  lastActivityAt DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
  @@index([userId])
  @@index([tokenHash])
  @@index([isActive])
  @@index([expiresAt])
}

model UserPushSubscription {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  endpoint  String   @unique
  keys      Json     // Contains p256dh and auth keys
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("user_push_subscriptions")
  @@index([userId])
}

model Employee {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @unique
  employeeCode String   @unique
  department   String
  position     String
  baseSalary   Float
  hireDate     DateTime
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  user           User             @relation(fields: [userId], references: [id])
  workShifts     WorkShift[]
  salaryAdvances SalaryAdvance[]
  payrollRecords PayrollRecord[]
  tasks          EmployeeTask[]
  assignedProjectTasks ProjectTask[] @relation("ProjectTaskAssignee")

  @@map("employees")
  @@index([department])
  @@index([isActive])
}

model Customer {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  userId          String       @unique
  customerType    CustomerType @default(REGULAR)
  totalPurchases  Float        @default(0)
  loyaltyPoints   Int          @default(0)
  creditLimit     Float        @default(0)
  currentBalance  Float        @default(0)
  preferredPayment String?
  
  // Credit Management Fields (SME Feature 1)
  creditHold      Boolean      @default(false)  // Khóa tín dụng
  isDeleted       Boolean      @default(false)  // Soft delete flag
  lastCreditCheck DateTime?                     // Lần kiểm tra gần nhất
  overdueAmount   Float        @default(0)      // Tổng nợ quá hạn
  maxOverdueDays  Int          @default(0)      // Số ngày quá hạn lâu nhất
  
  // Contractor Fields (SME Feature 3)
  contractorVerified Boolean   @default(false)  // Đã xác minh nhà thầu
  taxId           String?                       // Mã số thuế
  companyName     String?                       // Tên công ty
  companyAddress  String?                       // Địa chỉ công ty
  
  // Loyalty Program Fields
  loyaltyTier     LoyaltyTier  @default(BRONZE)
  loyaltyPointsToNextTier Int  @default(1000) // Points needed to reach next tier
  totalPointsEarned Int       @default(0)     // Lifetime points earned
  totalPointsRedeemed Int     @default(0)     // Lifetime points redeemed
  lastPurchaseDate DateTime?                 // For activity tracking
  purchaseFrequency Float      @default(0)     // Average purchases per month
  preferredCategories String[]               // Categories customer buys most
  birthday        DateTime?                  // For special promotions
  anniversaryDate DateTime?                  // Customer since date
  referralCode    String?     @unique        // For referral program
  referredBy      String?                    // Who referred this customer
  totalReferrals  Int         @default(0)    // Number of people they've referred
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relationships
  user    User    @relation(fields: [userId], references: [id])
  orders  Order[]
  invoices Invoice[]
  projects        Project[]  @relation("ProjectOwner")
  contractedProjects Project[] @relation("ProjectContractor")
  referrals Customer[] @relation("CustomerReferral")
  referredByCustomer Customer? @relation("CustomerReferral", fields: [referredBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  materialCalculations MaterialCalculation[]
  creditApprovals CreditApproval[]
  contracts Contract[]
  disputes Dispute[]
  
  // Brokerage
  quoteRequests   QuoteRequest[] @relation("CustomerOutboundQuotes")
  receivedQuotes  QuoteRequest[] @relation("ContractorInboundQuotes")
  cart            Cart?
  reportTokensCreated ProjectReportToken[]
  workerReportsManaged WorkerReport[]
  siteMaterialRequests SiteMaterialRequest[]
  contractorProfile     ContractorProfile?
  wallet                Wallet?
  loyaltyVouchers       LoyaltyVoucher[]
  
  // B2B Organization
  organizationId        String?      @db.ObjectId
  organization          Organization? @relation(fields: [organizationId], references: [id])
  
  customerReturns       CustomerReturn[]
  
  @@map("customers")
  @@index([customerType])
  @@index([loyaltyTier])
  @@index([totalPointsEarned])
  @@index([lastPurchaseDate])
  @@index([creditHold])
  @@index([contractorVerified])
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

model LoyaltyVoucher {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId    String   @db.ObjectId
  code          String   @unique
  value         Float
  pointsUsed    Int
  status        VoucherStatus @default(UNUSED)
  redeemedAt    DateTime @default(now())
  usedAt        DateTime?
  expiryDate    DateTime?

  customer      Customer @relation(fields: [customerId], references: [id])

  @@map("loyalty_vouchers")
  @@index([customerId])
  @@index([status])
}

enum VoucherStatus {
  UNUSED
  USED
  EXPIRED
}

// Work Shift and Attendance
model WorkShift {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  employeeId String
  date       DateTime
  startTime  String
  endTime    String
  shiftType  ShiftType   @default(REGULAR)
  status     ShiftStatus @default(SCHEDULED)
  clockIn    DateTime?
  clockOut   DateTime?
  breakTime  Int         @default(0) // minutes
  overtime   Int         @default(0) // minutes
  notes      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("work_shifts")
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([shiftType])
}

model EmployeeTask {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  employeeId  String
  title       String
  description String?
  taskType    TaskType   @default(GENERAL)
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  estimatedHours Float?
  actualHours    Float?
  proofUrl       String?
  proofNotes     String?
  submittedAt    DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("employee_tasks")
  @@index([employeeId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([taskType])
}

// Payroll Management
model SalaryAdvance {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  employeeId  String
  amount      Float
  reason      String
  requestDate DateTime      @default(now())
  approvedBy  String?
  approvedAt  DateTime?
  status      AdvanceStatus @default(PENDING)
  repaymentPeriod Int       @default(1) // months
  isRepaid    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("salary_advances")
  @@index([employeeId])
  @@index([status])
  @@index([requestDate])
}

model PayrollRecord {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  employeeId    String
  period        String   // YYYY-MM format
  baseSalary    Float
  bonuses       Float    @default(0)
  penalties     Float    @default(0)
  overtime      Float    @default(0)
  totalAdvances Float    @default(0)
  grossPay      Float
  taxDeductions Float    @default(0)
  otherDeductions Float  @default(0)
  netPay        Float
  hoursWorked   Float    @default(0)
  overtimeHours Float    @default(0)
  isPaid        Boolean  @default(false)
  paidAt        DateTime?
  generatedAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, period])
  @@map("payroll_records")
  @@index([employeeId])
  @@index([period])
  @@index([isPaid])
  @@index([generatedAt])
}

// Product and Inventory Management

model Category {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String    @unique
  description String?
  image       String?
  parentId    String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Category[] @relation("CategoryHierarchy")
  products Product[]
  priceTiers PriceTier[]

  @@map("categories")
  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
}

model Product {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  categoryId  String @db.ObjectId
  supplierId  String? @db.ObjectId  // Default supplier for this product
  sku         String  @unique
  price       Float
  costPrice   Float?
  unit        String  @default("pcs")
  weight      Float?
  dimensions  String?
  images      String[]
  tags        String[]
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  wholesalePrice    Float?   // Giá sỉ
  minWholesaleQty   Float    @default(10) // Số lượng tối thiểu để được giá sỉ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  category         Category           @relation(fields: [categoryId], references: [id])
  supplier         Supplier?          @relation(fields: [supplierId], references: [id])
  inventoryItem    InventoryItem?
  orderItems       OrderItem[]
  invoiceItems     InvoiceItem[]
  purchaseItems    PurchaseItem[]
  inventoryMovements InventoryMovement[]
  productReviews   ProductReview[]
  projectMaterials ProjectMaterial[]
  projectTaskMaterials ProjectTaskMaterial[]
  inventoryPredictions InventoryPrediction[]
  inventoryHistory InventoryHistory[]
  cartItems        CartItem[]
  purchaseReturnItems PurchaseReturnItem[]
  customerReturnItems CustomerReturnItem[]

  @@map("products")
  @@index([categoryId])
  @@index([name])
  @@index([isActive])
  @@index([isFeatured])
  @@index([price])
  @@index([createdAt])
  @@index([categoryId, isActive])
  @@index([isFeatured, isActive])
}

model InventoryItem {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  productId        String    @unique @db.ObjectId
  quantity         Float     @default(0)
  reservedQuantity Float     @default(0)
  availableQuantity Float    @default(0)
  minStockLevel    Float     @default(0)
  maxStockLevel    Float?
  reorderPoint     Float     @default(0)
  lastStockDate    DateTime?
  lastCountDate    DateTime?
  location         String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relationships
  product   Product             @relation(fields: [productId], references: [id])
  movements InventoryMovement[]
  binLinks  InventoryBinLink[]

  @@map("inventory_items")
  @@index([availableQuantity])
  @@index([minStockLevel])
  @@index([reorderPoint])
}

model InventoryMovement {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  productId     String       @db.ObjectId
  inventoryId   String       @db.ObjectId
  movementType  MovementType
  quantity      Float
  previousStock Float
  newStock      Float
  reason        String
  referenceType String?      // ORDER, PURCHASE, ADJUSTMENT, etc.
  referenceId   String?
  performedBy   String
  notes         String?
  createdAt     DateTime     @default(now())

  // Relationships
  product       Product       @relation(fields: [productId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryId], references: [id])

  @@map("inventory_movements")
  @@index([productId])
  @@index([inventoryId])
  @@index([movementType])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

// Order Management
model Order {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber     String      @unique
  customerId      String?     @db.ObjectId
  customerType    OrderCustomerType @default(REGISTERED)
  guestEmail      String?
  guestPhone      String?
  guestName       String?
  status          OrderStatus @default(PENDING_CONFIRMATION)
  totalAmount     Float
  taxAmount       Float       @default(0)
  shippingAmount  Float       @default(0)
  discountAmount  Float       @default(0)
  netAmount       Float
  paymentMethod   String?
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Deposit Payment Fields
  paymentType     OrderPaymentType @default(FULL)
  depositPercentage Int?         // 30, 40, 50
  depositAmount   Float?
  remainingAmount Float?
  depositPaidAt   DateTime?
  depositProof    String?       // URL to payment proof image
  qrExpiresAt     DateTime?     // QR code expiration time
  
  shippingAddress Json?
  billingAddress  Json?
  notes           String?
  expectedDelivery DateTime?
  actualDelivery   DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  confirmedBy     String?       // Admin who confirmed the order
  confirmedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Contractor Selection (Value-Added Service)
  selectedContractorId String?    @db.ObjectId
  contractorChangeCount Int        @default(0)

  // Relationships
  customer     Customer?   @relation(fields: [customerId], references: [id])
  contractor   ContractorProfile? @relation(fields: [selectedContractorId], references: [id])
  projectId    String?     @db.ObjectId
  project      Project?    @relation(fields: [projectId], references: [id])
  orderItems   OrderItem[]
  invoices     Invoice[]
  orderTracking OrderTracking[]
  delivery      OrderDelivery?
  deliveryPhases DeliveryPhase[]
  disputes      Dispute[]
  customerReturns CustomerReturn[]
  
  // B2B Organization support
  organizationId  String?      @db.ObjectId
  organization    Organization? @relation(fields: [organizationId], references: [id])
  b2bApprovalStatus B2BApprovalStatus @default(NOT_REQUIRED)

  @@map("orders")
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@index([customerType])
  @@index([paymentStatus])
  @@index([paymentType])
  @@index([qrExpiresAt])
}

model OrderItem {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId     String  @db.ObjectId
  productId   String  @db.ObjectId
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  discount    Float   @default(0)
  notes       String?
  createdAt   DateTime @default(now())

  // Relationships
  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
  @@index([orderId])
  @@index([productId])
  @@index([createdAt])
}

model OrderTracking {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId     String
  status      OrderStatus
  description String
  location    String?
  timestamp   DateTime @default(now())
  createdBy   String?

  // Relationships
  order Order @relation(fields: [orderId], references: [id])

  @@map("order_tracking")
  @@index([orderId])
  @@index([status])
  @@index([timestamp])
}

// Invoice Management
model Invoice {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  invoiceNumber String        @unique
  invoiceType   InvoiceType
  orderId       String?       @db.ObjectId
  customerId    String?       @db.ObjectId
  supplierId    String?       @db.ObjectId
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  status        InvoiceStatus @default(DRAFT)
  subtotal      Float
  taxAmount     Float         @default(0)
  discountAmount Float        @default(0)
  totalAmount   Float
  paidAmount    Float         @default(0)
  balanceAmount Float         @default(0)
  paymentTerms  String?
  notes         String?
  vatInvoiceUrl String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relationships
  order        Order?          @relation(fields: [orderId], references: [id])
  customer     Customer?       @relation(fields: [customerId], references: [id])
  supplier     Supplier?       @relation(fields: [supplierId], references: [id])
  invoiceItems InvoiceItem[]
  payments     Payment[]

  @@map("invoices")
  @@index([customerId])
  @@index([supplierId])
  @@index([status])
  @@index([issueDate])
  @@index([invoiceType])
}

model InvoiceItem {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId   String  @db.ObjectId
  productId   String  @db.ObjectId
  description String?
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  discount    Float   @default(0)
  taxRate     Float   @default(0)
  taxAmount   Float   @default(0)

  // Relationships
  invoice Invoice @relation(fields: [invoiceId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
  @@index([invoiceId])
  @@index([productId])
}

// Supplier Management
model Supplier {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  city          String?
  country       String?
  taxId         String?
  paymentTerms  String?
  creditLimit   Float    @default(0)
  currentBalance Float   @default(0)
  rating        Int?     @default(0)
  isActive      Boolean  @default(true)
  notes         String?
  password      String?    // Added for portal login
  
  // Bank Details
  bankName          String?
  bankAccountNumber String?
  bankAccountName   String?

  userId        String?  @unique @db.ObjectId // Optional: link to User table
  
  // 2FA & Profile Status
  is2FAEnabled      Boolean  @default(false)
  hasSetTwoFactor   Boolean  @default(false)
  twoFactorSecret   String?
  profileComplete   Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  user             User?              @relation(fields: [userId], references: [id])

  // Relationships
  products         Product[]
  invoices         Invoice[]
  purchaseOrders   PurchaseOrder[]
  supplierProducts SupplierProduct[]
  deliveryRatings  SupplierDeliveryRating[]
  promotions       SupplierPromotion[]
  returns          PurchaseReturn[]
  documents        SupplierDocument[]
  disputes         Dispute[]

  @@map("suppliers")
  @@index([name])
  @@index([isActive])
}



// Track quality ratings for each supplier delivery
model SupplierDeliveryRating {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  supplierId      String   @db.ObjectId
  purchaseOrderId String?  @db.ObjectId
  
  // Rating fields (1-5 scale)
  qualityRating   Int      @default(3) // Quality of delivered goods
  packagingRating Int      @default(3) // Packaging condition
  accuracyRating  Int      @default(3) // Order accuracy (correct items/quantities)
  
  // Time tracking
  responseHours   Float?   // Hours from order to acknowledgment
  deliveryHours   Float?   // Hours from order to delivery
  
  // Overall score (auto-calculated or manual)
  overallScore    Int      @default(3) // 1-5 overall rating
  
  // Metadata
  notes           String?
  ratedBy         String?  @db.ObjectId // Employee who rated
  ratedAt         DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@map("supplier_delivery_ratings")
  @@index([supplierId])
  @@index([ratedAt])
}

model PurchaseOrder {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber     String              @unique
  supplierId      String
  status          PurchaseOrderStatus @default(DRAFT)
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?
  receivedDate    DateTime?
  totalAmount     Float
  taxAmount       Float               @default(0)
  shippingAmount  Float               @default(0)
  discountAmount  Float               @default(0)
  netAmount       Float
  notes           String?
  createdBy       String
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relationships
  supplier      Supplier        @relation(fields: [supplierId], references: [id])
  purchaseItems PurchaseItem[]
  returns       PurchaseReturn[]

  @@map("purchase_orders")
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

model PurchaseItem {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  purchaseOrderId String
  productId       String
  quantity        Float
  unitPrice       Float
  totalPrice      Float
  receivedQuantity Float  @default(0)
  discount        Float   @default(0)
  notes           String?

  // Relationships
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  product       Product       @relation(fields: [productId], references: [id])

  @@map("purchase_items")
  @@index([purchaseOrderId])
  @@index([productId])
}

// Payment Management
model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  paymentNumber String        @unique
  invoiceId     String?
  orderId       String?
  paymentType   PaymentType
  paymentMethod PaymentMethod
  amount        Float
  currency      String        @default("USD")
  exchangeRate  Float         @default(1.0)
  status        PaymentStatus @default(PENDING)
  transactionId String?
  reference     String?
  beneficiaryInfo Json?       // Snapshot of bank details at time of payment
  paymentDate   DateTime      @default(now())
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relationships
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("payments")
  @@index([invoiceId])
  @@index([orderId])
  @@index([status])
  @@index([paymentDate])
}

// Product Reviews and Ratings
model ProductReview {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  productId  String   @db.ObjectId
  customerId String   @db.ObjectId
  orderId    String?  @db.ObjectId
  rating     Int      // 1-5 stars
  title      String?
  review     String?
  isVerified Boolean  @default(false)
  isPublished Boolean @default(true)
  helpfulCount Int    @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  product Product @relation(fields: [productId], references: [id])

  @@unique([productId, customerId, orderId])
  @@map("product_reviews")
  @@index([productId])
  @@index([customerId])
  @@index([rating])
  @@index([isPublished])
  @@index([createdAt])
}

// AI and Automation
model OCRProcessing {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  fileName     String
  filePath     String
  extractedText String?
  processedData Json?
  status       OCRStatus @default(PENDING)
  confidence   Float?
  errorMessage String?
  processedBy  String?
  reviewedBy   String?
  reviewedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("ocr_processing")
  @@index([status])
  @@index([createdAt])
  @@index([processedBy])
}

model CustomerInteraction {
  id             String            @id @default(auto()) @map("_id") @db.ObjectId
  customerId     String?
  sessionId      String
  interactionType InteractionType
  productId      String?
  query          String?
  response       String?
  sentiment      String?
  rating         Int?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime          @default(now())

  @@map("customer_interactions")
  @@index([customerId])
  @@index([sessionId])
  @@index([interactionType])
  @@index([productId])
  @@index([createdAt])
}

model InventoryPrediction {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  productId       String   @db.ObjectId
  predictionDate  DateTime @default(now())
  targetDate      DateTime @default(now()) // Date we're predicting for
  timeframe       String   // WEEK, MONTH, QUARTER
  predictedDemand Float
  confidence      Float    // 0-1
  method          String   @default("LINEAR_REGRESSION") // LINEAR_REGRESSION, ML_MODEL, etc.
  factors         Json?    // trend, seasonality, etc.
  recommendedOrder Float?
  
  // Actual data (filled later for validation)
  actualDemand    Float?
  accuracy        Float?   // 0-100
  error           Float?   // Absolute error
  validatedAt     DateTime?
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  
  product         Product  @relation(fields: [productId], references: [id])

  @@map("inventory_predictions")
  @@index([productId])
  @@index([predictionDate])
  @@index([targetDate])
  @@index([timeframe])
  @@index([confidence])
  @@index([isActive])
}

// Enums
enum UserRole {
  MANAGER
  EMPLOYEE
  CUSTOMER
  CONTRACTOR
  SUPPLIER
}

enum CustomerType {
  REGULAR
  VIP
  WHOLESALE
  CONTRACTOR
}

enum ShiftType {
  REGULAR
  OVERTIME
  LOADING
  TRANSPORT
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  ABSENT
  CANCELLED
}

enum TaskType {
  GENERAL
  LOADING
  TRANSPORT
  INVENTORY
  SALES
  MAINTENANCE
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  AWAITING_REVIEW
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AdvanceStatus {
  PENDING
  APPROVED
  REJECTED
  REPAID
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
  DAMAGE
  RETURN
}

enum OrderStatus {
  PENDING_CONFIRMATION      // Chờ admin xác nhận đơn
  CONFIRMED_AWAITING_DEPOSIT // Admin đã xác nhận, chờ khách cọc
  DEPOSIT_PAID             // Đã cọc, đang xử lý
  PENDING                  // Chờ xử lý (cho đơn thanh toán đầy đủ)
  CONFIRMED                // Đã xác nhận
  PROCESSING               // Đang chuẩn bị hàng
  SHIPPED                  // Đang giao hàng
  DELIVERED                // Đã giao hàng
  CANCELLED                // Đã hủy
  RETURNED                 // Đã trả hàng
  COMPLETED                // Đã hoàn thành (sau khi thanh toán & nhận hàng)
}

enum OrderCustomerType {
  REGISTERED
  GUEST
  CONTRACTOR
}

enum OrderPaymentType {
  FULL      // Thanh toán đầy đủ
  DEPOSIT   // Đặt cọc trước
  CREDIT    // Mua trước trả sau (công nợ)
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum InvoiceType {
  SALES
  PURCHASE
  RETURN
  CREDIT_NOTE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentType {
  INCOMING
  OUTGOING
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHECK
  DIGITAL_WALLET
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  RECEIVED
  RETURNED
  PARTIALLY_RETURNED
  CANCELLED
}

enum OCRStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REVIEWED
}

enum InteractionType {
  PRODUCT_VIEW
  PRODUCT_SEARCH
  ADD_TO_CART
  PURCHASE
  CHATBOT
  REVIEW
  SUPPORT
}

// Notifications Model
model Notification {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?     @db.ObjectId
  supplierId  String?     @db.ObjectId
  title       String
  message     String
  type        NotificationType @default(INFO)
  priority    Priority   @default(MEDIUM)
  read        Boolean    @default(false)
  referenceId String?
  referenceType String?
  metadata    Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  user        User?      @relation(fields: [userId], references: [id])

  @@map("notifications")
  @@index([userId])
  @@index([supplierId])
  @@index([type])
  @@index([priority])
  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  STOCK_ALERT
  ORDER_NEW
  ORDER_UPDATE
  PAYMENT_UPDATE
  PROJECT_MATCH
}

// Project Management
model Project {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String?
  category        String?    @default("general")
  customerId      String?    @db.ObjectId
  status          ProjectStatus @default(PLANNING)
  startDate       DateTime
  endDate         DateTime?
  budget          Float
  actualCost      Float      @default(0)
  progress        Int        @default(0) // 0-100%
  priority        Priority   @default(MEDIUM)
  notes           String?
  location        String?
  
  // Guest fields
  guestName       String?
  guestPhone      String?
  guestEmail      String?
  
  // Moderation & Public Visibility
  moderationStatus ModerationStatus @default(PENDING)
  isPublic        Boolean    @default(false)
  approvedAt      DateTime?
  approvedBy      String?    @db.ObjectId // Employee/Admin ID
  
  // Verification for Guests
  isVerified      Boolean    @default(false)
  otpCode         String?
  otpExpiresAt    DateTime?
  verificationId  String?    // To handle step-by-step verification
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  customer        Customer?  @relation("ProjectOwner", fields: [customerId], references: [id])
  contractorId    String?    @db.ObjectId
  contractor      Customer?  @relation("ProjectContractor", fields: [contractorId], references: [id])
  projectTasks    ProjectTask[]
  projectMaterials ProjectMaterial[]
  quoteRequests   QuoteRequest[]

  orders          Order[]

  // B2B Organization support
  organizationId  String?      @db.ObjectId
  organization    Organization? @relation(fields: [organizationId], references: [id])

  @@map("projects")
  @@index([customerId])
  @@index([status])
  @@index([priority])
  @@index([startDate])
  @@index([moderationStatus])
  @@index([isPublic])
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

model ProjectTask {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  projectId   String
  name        String
  description String?
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  assigneeId  String?    // Employee ID
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  estimatedHours Float?
  actualHours    Float?
  progress    Int        @default(0) // 0-100%
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  project     Project    @relation(fields: [projectId], references: [id])
  assignee    Employee?  @relation("ProjectTaskAssignee", fields: [assigneeId], references: [id])
  taskMaterials ProjectTaskMaterial[]

  @@map("project_tasks")
  @@index([projectId])
  @@index([status])
  @@index([priority])
  @@index([assigneeId])
}

model ProjectMaterial {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId   String
  productId   String
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  status      MaterialStatus @default(REQUESTED)
  requestedAt DateTime @default(now())
  deliveredAt DateTime?
  notes       String?

  // Relationships
  project     Project  @relation(fields: [projectId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])

  @@map("project_materials")
  @@index([projectId])
  @@index([productId])
  @@index([status])
}

model ProjectTaskMaterial {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId      String
  productId   String
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  status      MaterialStatus @default(REQUESTED)
  requestedAt DateTime @default(now())
  deliveredAt DateTime?
  notes       String?

  // Relationships
  task        ProjectTask @relation(fields: [taskId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])

  @@map("project_task_materials")
  @@index([taskId])
  @@index([productId])
  @@index([status])
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum MaterialStatus {
  REQUESTED
  ORDERED
  DELIVERED
  CANCELLED
}

// Material Calculator
model MaterialCalculation {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String?
  projectType     String
  projectData     Json     // Store all project inputs
  calculationResult Json   // Store complete calculation results
  totalEstimate   Float
  status          String   @default("DRAFT") // DRAFT, CONFIRMED, ORDERED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("material_calculations")
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

// Inventory History (for tracking all changes)
model InventoryHistory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  productId       String
  changeType      String   // SALE, PURCHASE, ADJUSTMENT, RETURN
  quantityChange  Float    // Can be negative
  quantityBefore  Float?
  quantityAfter   Float
  reason          String?
  referenceId     String?  // Order ID, Purchase Order ID, etc.
  performedBy     String?  // User who made the change
  createdAt       DateTime @default(now())
  
  product         Product  @relation(fields: [productId], references: [id])
  
  @@map("inventory_history")
  @@index([productId])
  @@index([changeType])
  @@index([createdAt])
}

// ============================================
// SME FEATURE 1: QUẢN LÝ CÔNG NỢ (DEBT MANAGEMENT)
// ============================================

// Cấu hình luật công nợ
model DebtConfiguration {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  name                String   @unique // Tên luật (VD: "Default", "VIP", "Contractor")
  maxOverdueDays      Int      @default(30)  // Số ngày quá hạn tối đa cho phép
  creditLimitPercent  Float    @default(100) // % hạn mức được sử dụng (100 = 100%)
  autoHoldOnOverdue   Boolean  @default(true) // Tự động khóa khi quá hạn
  warningDays         Int      @default(7)   // Cảnh báo trước khi đến hạn
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("debt_configurations")
}

// Lịch sử duyệt ngoại lệ công nợ
model CreditApproval {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String
  orderId         String?             // Order đang chờ duyệt (nếu có)
  requestedAmount Float               // Số tiền yêu cầu
  currentDebt     Float               // Nợ hiện tại tại thời điểm request
  creditLimit     Float               // Hạn mức tại thời điểm request
  reason          String              // Lý do xin duyệt
  status          CreditApprovalStatus @default(PENDING)
  approvedBy      String?             // User ID người duyệt
  approvedAt      DateTime?
  rejectedReason  String?
  expiresAt       DateTime?           // Thời hạn hiệu lực của approval
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relationships
  customer        Customer            @relation(fields: [customerId], references: [id])

  @@map("credit_approvals")
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

enum CreditApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// ============================================
// SME FEATURE 2: NHẬP HÀNG THÔNG MINH (SMART PROCUREMENT)
// ============================================

// Liên kết Nhà cung cấp - Sản phẩm (với giá và thời gian giao)
model SupplierProduct {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  supplierId      String
  productId       String
  unitPrice       Float               // Giá nhập từ NCC này
  minOrderQty     Float    @default(1) // Số lượng tối thiểu
  leadTimeDays    Int      @default(3) // Thời gian giao hàng (ngày)
  isPreferred     Boolean  @default(false) // NCC ưu tiên cho SP này
  lastPurchaseDate DateTime?
  averageRating   Float    @default(5) // Đánh giá NCC (1-5)
  notes           String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  supplier        Supplier @relation(fields: [supplierId], references: [id])

  @@unique([supplierId, productId])
  @@map("supplier_products")
  @@index([productId])
  @@index([supplierId])
  @@index([isPreferred])
}

// Yêu cầu nhập hàng (tự động hoặc thủ công)
model PurchaseRequest {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  requestNumber   String              @unique
  productId       String
  supplierId      String?             // NCC được đề xuất
  requestedQty    Float               // Số lượng đề xuất nhập
  currentStock    Float               // Tồn kho hiện tại lúc tạo
  reorderPoint    Float               // Điểm đặt hàng lúc tạo
  estimatedCost   Float?              // Chi phí ước tính
  source          PurchaseRequestSource @default(SYSTEM) // Tự động hay thủ công
  status          PurchaseRequestStatus @default(PENDING)
  priority        Priority            @default(MEDIUM)
  approvedBy      String?
  approvedAt      DateTime?
  purchaseOrderId String?             // Liên kết với PO sau khi duyệt
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("purchase_requests")
  @@index([productId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

enum PurchaseRequestSource {
  SYSTEM      // Hệ thống tự động tạo
  MANUAL      // Thủ công
}

enum PurchaseRequestStatus {
  PENDING     // Chờ duyệt
  APPROVED    // Đã duyệt
  REJECTED    // Từ chối
  CONVERTED   // Đã chuyển thành PO
  CANCELLED   // Đã hủy
}

// ============================================
// SME FEATURE 3: GIÁ B2B & HỢP ĐỒNG (CONTRACT PRICING)
// ============================================

// Bảng giá đa cấp
model PriceList {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String   @unique // "Giá lẻ", "Giá đại lý cấp 1", "Giá nhà thầu"
  code            String   @unique // "RETAIL", "DEALER_1", "CONTRACTOR"
  description     String?
  discountPercent Float    @default(0) // % giảm so với giá gốc
  customerTypes   CustomerType[] // Áp dụng cho loại khách hàng nào
  priority        Int      @default(0) // Ưu tiên (số cao = ưu tiên hơn)
  isActive        Boolean  @default(true)
  validFrom       DateTime?
  validTo         DateTime?
  createdAt       DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  tiers               PriceTier[] // Bậc giá theo số lượng

  @@map("price_lists")
  @@index([isActive])
  @@index([priority])
}

// Bậc giá theo số lượng cho PriceList
model PriceTier {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  priceListId  String    @db.ObjectId
  categoryId   String?   @db.ObjectId // Ngành hàng áp dụng (Nếu null thì áp dụng toàn bộ)
  minQuantity  Float     // Số lượng từ (>=)
  discountPercent Float  // % giảm giá
  
  priceList    PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  category     Category? @relation(fields: [categoryId], references: [id])

  @@map("price_tiers")
}






model QuoteRequest {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  customerId   String      @db.ObjectId
  contractorId String      @db.ObjectId
  projectId    String?     @db.ObjectId
  status       QuoteStatus @default(PENDING)
  details      String
  budget       Float?
  location     String?
  startDate    DateTime?
  
  // Response from contractor
  response     String?
  priceQuote   Float?      // Total from QuoteItems
  respondedAt  DateTime?
  
  // Flow 4: Versioning & Negotiation
  version      Int         @default(1)
  parentQuoteId String?    @db.ObjectId // Link to the original or previous version
  isLatest     Boolean     @default(true)
  
  // Flow 2: Digital Verification
  otpCode      String?
  otpExpiresAt DateTime?
  isVerified   Boolean     @default(false)
  verifiedAt   DateTime?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relationships
  customer     Customer    @relation("CustomerOutboundQuotes", fields: [customerId], references: [id])
  contractor   Customer    @relation("ContractorInboundQuotes", fields: [contractorId], references: [id])
  project      Project?    @relation(fields: [projectId], references: [id])

  attachments  String[]    // List of file URLs (drawings, specs)
  conversationId String?   @db.ObjectId // Reference to chat conversation
  
  // Flow 1: Detailed BoQ
  items        QuoteItem[]
  
  // Flow 3: Staged Payments
  milestones   PaymentMilestone[]
  
  // Staged Payments & Escrow
  totalAmount  Float?      // Tổng giá trị (đã bao gồm phí)
  platformFee  Float       @default(0) // Phí môi giới sàn thu
  escrowBalance Float      @default(0) // Số tiền hiện đang treo ký quỹ
  
  metadata     Json?       // Extra metadata
  
  history      QuoteStatusHistory[]
  milestoneReports WorkerReport[]

  @@map("quote_requests")
  @@index([customerId])
  @@index([contractorId])
  @@index([status])
  @@index([parentQuoteId])
}

// Flow 1: Bill of Quantities (BoQ)
model QuoteItem {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  quoteId      String      @db.ObjectId
  description  String      // Name of material or task
  quantity     Float
  unit         String      // kg, m2, box, day...
  unitPrice    Float
  totalPrice   Float
  category     String?     // Material, Labor, Other
  
  quote        QuoteRequest @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_items")
}

// Flow 3: Payment Milestones
model PaymentMilestone {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  quoteId        String        @db.ObjectId
  quote          QuoteRequest  @relation(fields: [quoteId], references: [id])
  name           String        // VD: Tạm ứng, Xong phần thô...
  percentage     Float
  amount         Float
  order          Int           @default(1)
  status         String        @default("PENDING") // PENDING, ESCROW_PAID, COMPLETED, RELEASED
  paidAt         DateTime?
  
  // Evidence of completion
  evidenceUrl   String?
  evidenceNotes String?
  
  createdAt      DateTime      @default(now())
  workerReports  WorkerReport[]
  
  // Escrow tracking
  escrowStatus   MilestoneEscrowStatus @default(PENDING) // PENDING -> DEPOSITED -> RELEASED
  proofImageUrl  String?       // Ảnh nghiệm thu thực tế
  confirmedAt    DateTime?     // Thời điểm khách nhấn duyệt nghiệm thu

  @@map("payment_milestones")
}

enum MilestoneEscrowStatus {
  PENDING         // Chưa thanh toán
  DEPOSITED       // Khách đã nạp tiền vào quỹ treo
  RELEASED        // Sàn đã chuyển tiền cho nhà thầu
  DISPUTED        // Đang tranh chấp
}

model QuoteStatusHistory {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  quoteId      String      @db.ObjectId
  userId       String      @db.ObjectId // User who made the change
  oldStatus    QuoteStatus?
  newStatus    QuoteStatus
  notes        String?
  createdAt    DateTime    @default(now())

  quote        QuoteRequest @relation(fields: [quoteId], references: [id])

  @@map("quote_status_history")
  @@index([quoteId])
}

enum QuoteStatus {
  PENDING
  REPLIED
  ACCEPTED
  REJECTED
  CANCELLED
}

// Hợp đồng giá với khách hàng
model Contract {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  contractNumber  String         @unique
  customerId      String         @db.ObjectId
  quoteId         String?        @db.ObjectId
  name            String         // Tên hợp đồng
  description     String?
  contractType    ContractType   @default(FIXED_PRICE)
  status          ContractStatus @default(DRAFT)
  validFrom       DateTime
  validTo         DateTime
  totalValue      Float?         // Tổng giá trị hợp đồng (nếu có)
  usedValue       Float          @default(0) // Đã sử dụng
  creditTermDays  Int            @default(30) // Số ngày công nợ cho HĐ này
  specialCreditLimit Float?      // Hạn mức đặc biệt cho HĐ này
  terms           String?        // Điều khoản
  approvedBy      String?
  approvedAt      DateTime?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relationships
  customer        Customer       @relation(fields: [customerId], references: [id])
  contractPrices  ContractPrice[]

  @@map("contracts")
  @@index([customerId])
  @@index([status])
  @@index([validFrom])
  @@index([validTo])
}

// Giá sản phẩm trong hợp đồng
model ContractPrice {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  contractId      String
  productId       String
  fixedPrice      Float?          // Giá cố định (nếu có)
  discountPercent Float?          // % giảm giá (nếu không dùng giá cố định)
  minQuantity     Float    @default(0) // Số lượng tối thiểu để áp dụng giá này
  maxQuantity     Float?          // Số lượng tối đa (null = không giới hạn)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  contract        Contract @relation(fields: [contractId], references: [id])

  @@unique([contractId, productId])
  @@map("contract_prices")
  @@index([contractId])
  @@index([productId])
}

enum ContractType {
  FIXED_PRICE     // Giá cố định
  DISCOUNT        // Chiết khấu %
  VOLUME          // Theo sản lượng
  MIXED           // Kết hợp
}

enum ContractStatus {
  DRAFT           // Nháp
  PENDING         // Chờ duyệt
  ACTIVE          // Đang hiệu lực
  EXPIRED         // Hết hạn
  CANCELLED       // Đã hủy
  SUSPENDED       // Tạm dừng
}

// ============================================
// MARKETPLACE: CONTRACTOR PROFILES
// ============================================


model ContractorProfile {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String   @unique
  displayName     String
  bio             String?
  phone           String?
  email           String?
  website         String?
  companyName     String?
  customer        Customer @relation(fields: [customerId], references: [id])
  experienceYears Int?
  skills          String[]  // List of skills/specialties
  isVerified      Boolean  @default(false)
  onboardingStatus String   @default("INCOMPLETE") // INCOMPLETE, PENDING_REVIEW, VERIFIED, REJECTED
  isAvailable     Boolean  @default(true)
  
  // Market filters
  city            String?
  district        String?
  address         String?
  avgRating       Float    @default(0)
  reviewCount     Int      @default(0)
  
  // Flow 5: Trust Score
  trustScore      Float    @default(100) // Điểm tín nhiệm (0-100)
  totalProjectsCompleted Int @default(0) // Tổng số dự án đã hoàn thành
  
  // Additional profile details
  teamSize        Int      @default(1)
  portfolioImages String[]
  portfolioDesc   String[]
  documents       String[]
  
  // Showcase / Spotlight (Flow 4)
  highlightBio    String?   // Short slogan or highlight
  awards          String[]  // Notable awards or certifications
  featuredProjects Json?    // Structured featured work: [{title, year, image, desc}]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  disputes        Dispute[]

  // Relationships
  reviews         ContractorReview[]
  orders          Order[]
  savedProjects   SavedProject[]

  @@map("contractor_profiles")
  @@index([isVerified])
  @@index([city])
  @@index([avgRating])
  @@index([trustScore])
}

model SavedProject {
  id           String              @id @default(auto()) @map("_id") @db.ObjectId
  contractorId String              @db.ObjectId
  projectId    String              @db.ObjectId
  savedAt      DateTime            @default(now())

  contractor   ContractorProfile   @relation(fields: [contractorId], references: [id])
  project      ConstructionProject @relation(fields: [projectId], references: [id])

  @@map("saved_projects")
  @@unique([contractorId, projectId])
  @@index([contractorId])
}

model Cart {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  customerId  String     @unique @db.ObjectId
  items       CartItem[]
  totalItems  Float      @default(0)
  subtotal    Float      @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  customer    Customer   @relation(fields: [customerId], references: [id])

  @@map("carts")
}

model CartItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  cartId      String   @db.ObjectId
  productId   String   @db.ObjectId
  productName String
  quantity    Float
  unit        String
  unitPrice   Float
  originalPrice Float?
  discountPercent Float? @default(0)
  subtotal    Float
  source      String?  // BOQ, DIRECT
  sourceApplicationId String? @db.ObjectId
  sourceProjectTitle String?
  createdAt   DateTime @default(now())

  cart        Cart     @relation(fields: [cartId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

model ContractorReview {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  contractorId  String   @db.ObjectId
  reviewerId    String   // Customer or User ID
  projectId     String?  // Optional project reference
  rating        Int      // 1-5 sao tổng thể
  
  // Flow 5: Trust Metrics
  priceAccuracy   Int      @default(5) // 1-5 sao về tính đúng giá
  materialQuality Int      @default(5) // 1-5 sao về chất lượng vật tư
  
  title         String?
  comment       String
  isApproved    Boolean  @default(true)
  isHidden      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  metadata      Json?

  // Relationships
  contractor    ContractorProfile @relation(fields: [contractorId], references: [id])

  @@map("contractor_reviews")
  @@index([contractorId])
  @@index([reviewerId])
  @@index([rating])
  @@index([isApproved])
}

model ProjectReportToken {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  token        String   @unique
  projectId    String   @db.ObjectId
  contractorId String   @db.ObjectId // The contractor who generated it
  milestoneId  String?  @db.ObjectId // Optional: specific milestone this report is for
  
  expiresAt    DateTime?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  // Relationships
  project    ConstructionProject @relation(fields: [projectId], references: [id])
  contractor Customer            @relation(fields: [contractorId], references: [id])

  @@map("project_report_tokens")
}

model WorkerReport {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId    String   @db.ObjectId
  contractorId String   @db.ObjectId
  milestoneId  String?  @db.ObjectId // Associated milestone
  quoteId      String?  @db.ObjectId // Associated quote for milestones
  workerName   String
  photoUrl     String
  imageHash    String?  // NEW: For duplicate detection (AI Anti-fraud)
  notes        String?
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  customerStatus String @default("PENDING") // NEW: PENDING, APPROVED, DISPUTED
  rejectionReason String? // NEW: Reason if customer rejects
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project    ConstructionProject @relation(fields: [projectId], references: [id])
  contractor Customer            @relation(fields: [contractorId], references: [id])
  milestone  PaymentMilestone?   @relation(fields: [milestoneId], references: [id])
  quote      QuoteRequest?       @relation(fields: [quoteId], references: [id])

  @@map("worker_reports")
  @@index([projectId])
  @@index([status])
  @@index([milestoneId])
  @@index([imageHash])
}

// ============================================
// MARKETPLACE: PROJECTS
// ============================================

enum ProjectType {
  NEW_BUILD      // Xây mới
  RENOVATION     // Sửa chữa/Cải tạo
  INTERIOR       // Nội thất
  ELECTRICAL     // Điện
  PLUMBING       // Nước
  ROOFING        // Mái
  OTHER          // Khác
}

model MarketProject {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String        @db.ObjectId // Owner of the project
  title           String
  description     String
  projectType     ProjectType   @default(NEW_BUILD)
  status          ProjectStatus @default(PLANNING)
  address         String?
  district        String?
  city            String        @default("Biên Hòa")
  budgetMin       Float?        // Minimum budget
  budgetMax       Float?        // Maximum budget
  startDate       DateTime?     // Expected start date
  endDate         DateTime?     // Expected end date
  requirements    String[]      // Required skills
  images          String[]      // Project images
  isUrgent        Boolean       @default(false)
  viewCount       Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relationships
  applications    MarketProjectApplication[]

  @@map("market_projects")
  @@index([status])
  @@index([projectType])
  @@index([city])
  @@index([isUrgent])
}

model MarketProjectApplication {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId       String   @db.ObjectId
  contractorId    String   @db.ObjectId
  message         String   // Application message
  proposedBudget  Float?   // Proposed budget
  proposedDays    Int?     // Proposed number of days to complete
  status          String   @default("PENDING") // PENDING, ACCEPTED, REJECTED, WITHDRAWN
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  project         MarketProject @relation(fields: [projectId], references: [id])

  @@map("market_project_applications")
  @@index([projectId])
  @@index([contractorId])
  @@index([status])
}

model ConstructionProject {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String
  projectType     String
  location        String
  district        String?
  city            String   @default("Biên Hòa")
  estimatedBudget Float?
  budgetType      String   @default("NEGOTIABLE")
  requirements    String[]
  materialsNeeded String[]
  images          String[]
  contactName     String
  contactPhone    String
  contactEmail    String?
  customerId      String   @default("guest")
  actualCost      Float    @default(0)
  status          String   @default("OPEN")
  isUrgent        Boolean  @default(false)
  isFeatured      Boolean  @default(false)
  viewCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  applications    ProjectApplication[]
  reportTokens    ProjectReportToken[]
  workerReports   WorkerReport[]
  siteMaterialRequests SiteMaterialRequest[]
  expenses             ProjectExpense[]
  savedBy              SavedProject[]
  
  // B2B Organization support
  organizationId  String?      @db.ObjectId
  organization    Organization? @relation(fields: [organizationId], references: [id])
  
  @@map("construction_projects")
  @@index([status])
  @@index([projectType])
  @@index([city])
  @@index([customerId])
}

model ProjectExpense {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId    String?  @db.ObjectId
  contractorId String?  @db.ObjectId
  category     String   // MATERIALS, LABOR, TRANSPORT, OTHER
  amount       Float
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project      ConstructionProject? @relation(fields: [projectId], references: [id])
  
  @@map("project_expenses")
}

model ProjectApplication {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId       String   @db.ObjectId
  contractorId    String?  // Null if guest
  
  // Guest Support (Provisional Profile)
  isGuest         Boolean  @default(false)
  guestName       String?
  guestPhone      String?
  guestEmail      String?
  
  message         String
  proposedBudget  Float?
  proposedDays    Int?
  status          String   @default("PENDING") // PENDING, NEGOTIATING, SHORTLISTED, SELECTED, REJECTED, CLOSED
  
  // Flow 3: BoQ (Materials)
  materials       Json?    // [{id, name, quantity, unit, price}]
  
  // Flow 1: Attachments
  attachments     String[] // URLs to PDF/Images
  
  // Flow 2: Privacy
  isContactUnlocked Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  project         ConstructionProject @relation(fields: [projectId], references: [id])

  @@map("project_applications")
  @@index([projectId])
  @@index([contractorId])
  @@index([status])
}


// ============================================
// SAVED ESTIMATES (AI Estimator)
// ============================================

model SavedEstimate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId  String?  // For logged-in users
  sessionId   String?  // For guest users
  projectType String   // Type of project (wall, floor, etc.)
  projectName String?  // User-given name
  area        Float    // Area in m²
  materials   Json     // Array of calculated materials with quantities and prices
  totalCost   Float    // Total estimated cost
  notes       String?  // User notes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  phases      ProjectPhase[]
  reminders   ProjectReminder[]

  @@map("saved_estimates")
  @@index([customerId])
  @@index([sessionId])
}

// ============================================
// PROJECT ROADMAP (AI Timeline)
// ============================================

enum PhaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

model ProjectPhase {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  estimateId      String      @db.ObjectId
  name            String      // Phase name: "Móng", "Xây thô", "Lát nền"...
  description     String?     // AI-generated description
  order           Int         // Sequence order
  status          PhaseStatus @default(PENDING)
  
  // Timeline
  estimatedStartDate DateTime?
  estimatedEndDate   DateTime?
  actualStartDate    DateTime?
  actualEndDate      DateTime?
  
  // Materials for this phase
  recommendedMaterials Json?   // Array of { productId, name, quantity, priority }
  purchaseDeadline     DateTime? // When materials should be ordered
  
  // Progress
  completionPercent Int @default(0)
  notes            String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relationships
  estimate         SavedEstimate @relation(fields: [estimateId], references: [id])

  @@map("project_phases")
  @@index([estimateId])
  @@index([status])
  @@index([order])
}

model ProjectReminder {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  estimateId   String   @db.ObjectId
  customerId   String?
  
  // Reminder details
  title        String
  message      String
  type         String   // MATERIAL_PURCHASE, PHASE_START, DEADLINE, CUSTOM
  priority     String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  
  // Scheduling
  scheduledFor DateTime
  sentAt       DateTime?
  isRead       Boolean  @default(false)
  isDismissed  Boolean  @default(false)
  
  // Reference
  phaseId      String?  @db.ObjectId
  productIds   String[] // Products to remind about
  
  createdAt    DateTime @default(now())

  // Relationships
  estimate     SavedEstimate @relation(fields: [estimateId], references: [id])

  @@map("project_reminders")
  @@index([estimateId])
  @@index([customerId])
  @@index([scheduledFor])
  @@index([isRead])
}

// ============================================
// CHAT SUMMARY (Smart Settlement)
// ============================================

model ChatSummary {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId  String   @db.ObjectId
  
  // Summary content
  title           String   // Auto-generated title
  summary         String   // Full AI summary
  
  // Extracted key points
  agreedPrice     Float?   // Extracted agreed price
  priceUnit       String?  // "m2", "total", "day"...
  agreedDate      DateTime? // Agreed delivery/start date
  keyTerms        Json?    // Array of { term, value, confidence }
  
  // Participants info at time of summary
  participant1Name String
  participant2Name String
  
  // Messages covered
  messageCount    Int
  fromMessageId   String?  @db.ObjectId
  toMessageId     String?  @db.ObjectId
  
  // Status
  isConfirmed     Boolean  @default(false) // Both parties confirmed
  confirmedBy     String[] // IDs of users who confirmed
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("chat_summaries")
  @@index([conversationId])
  @@index([createdAt])
}

// ============================================
// CHAT & MESSAGING
// ============================================

model Conversation {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  participant1Id   String
  participant1Name String
  participant2Id   String
  participant2Name String
  projectId        String?   @db.ObjectId
  projectTitle     String?
  lastMessage      String?
  lastMessageAt    DateTime?
  unread1          Int       @default(0)
  unread2          Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  messages         Message[]

  @@map("conversations")
  @@index([participant1Id])
  @@index([participant2Id])
}

model Message {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String       @db.ObjectId
  senderId       String
  senderName     String
  senderRole     String?
  realSenderId   String?
  content        String?
  
  // File attachments
  fileUrl        String?
  fileName       String?
  fileType       String?      // image, document, video, etc.
  fileSize       Int?
  
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id])

  @@map("messages")
  @@index([conversationId])
  @@index([senderId])
}

// ============================================
// CUSTOMER SUPPORT
// ============================================

enum SupportStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model SupportRequest {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  phone           String
  email           String?
  message         String
  status          SupportStatus @default(PENDING)
  priority        Priority      @default(MEDIUM)
  
  // System Info
  ipAddress       String?
  userAgent       String?
  browserName     String?
  browserVersion  String?
  osName          String?
  osVersion       String?
  deviceType      String?       // mobile, desktop, tablet
  screenRes       String?       // e.g. 1920x1080
  
  // Context
  pageUrl         String?
  userId          String?       // If logged in
  
  // Attachments
  attachments     Json?         // Array of { fileUrl, fileName, fileType, fileSize }
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("support_requests")
  @@index([status])
  @@index([createdAt])
  @@index([phone])
}

// ============================================
// NEW FLOW MODELS
// ============================================

model SiteMaterialRequest {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId    String   @db.ObjectId
  contractorId String   @db.ObjectId
  workerName   String
  items        Json     // [{name, quantity, unit, notes}]
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED, ORDERED
  priority     Priority @default(MEDIUM)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project    ConstructionProject @relation(fields: [projectId], references: [id])
  contractor Customer            @relation(fields: [contractorId], references: [id])

  @@map("site_material_requests")
}

model OrderDelivery {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String   @unique @db.ObjectId
  driverId        String?  @db.ObjectId // If assigned to a specific employee
  deliveryToken   String   @unique // For the driver's public link
  status          String   @default("ASSIGNED") // ASSIGNED, SHIPPED, DELIVERED, FAILED
  shippedAt       DateTime?
  deliveredAt     DateTime?
  proofImageUrl   String?
  evidenceNotes   String?
  
  // Real-time Tracking (Flow 3)
  currentLat      Float?   // NEW: Current GPS Latitude
  currentLng      Float?   // NEW: Current GPS Longitude
  lastLocationUpdate DateTime? // NEW

  deliveryLat     Float?
  deliveryLng     Float?
  recipientName   String?
  
  order           Order    @relation(fields: [orderId], references: [id])

  @@map("order_deliveries")
}

// ============================================
// SME FEATURE: DISPUTE CENTER (TRUNG TÂM TRANH CHẤP)
// ============================================

model Dispute {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String?  @db.ObjectId
  projectId       String?  @db.ObjectId
  
  // Actor identification
  type            DisputeType @default(CUSTOMER_TO_STORE)
  
  customerId      String?  @db.ObjectId // Involved customer
  contractorId    String?  @db.ObjectId // Involved contractor
  supplierId      String?  @db.ObjectId // Involved supplier
  
  reason          String
  description     String
  status          DisputeStatus @default(OPEN)
  resolution      String?      // Admin resolution
  resolvedAt      DateTime?
  resolvedBy      String?      @db.ObjectId // Admin ID
  
  evidence        DisputeEvidence[]
  comments        DisputeComment[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  order           Order?   @relation(fields: [orderId], references: [id])
  customer        Customer? @relation(fields: [customerId], references: [id])
  contractor      ContractorProfile? @relation(fields: [contractorId], references: [id])
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  
  @@map("disputes")
  @@index([status])
  @@index([type])
  @@index([orderId])
}

model DisputeComment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  disputeId       String   @db.ObjectId
  authorId        String   @db.ObjectId // User ID
  content         String
  attachments     String[] // Array of image URLs
  
  createdAt       DateTime @default(now())
  
  dispute         Dispute  @relation(fields: [disputeId], references: [id])
  author          User     @relation(fields: [authorId], references: [id])

  @@map("dispute_comments")
  @@index([disputeId])
}

enum DisputeType {
  CUSTOMER_TO_STORE
  CUSTOMER_TO_CONTRACTOR
  CONTRACTOR_TO_CUSTOMER
  CONTRACTOR_TO_STORE
  SUPPLIER_TO_STORE
}

model DisputeEvidence {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  disputeId       String   @db.ObjectId
  imageUrl        String
  description     String?
  
  dispute         Dispute  @relation(fields: [disputeId], references: [id])
  
  @@map("dispute_evidences")
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
}
model Wallet {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String   @unique @db.ObjectId
  balance         Float    @default(0) // Số dư khả dụng (VND)
  holdBalance     Float    @default(0) // Tiền đang chờ duyệt (Escrow hoặc sỉ chưa giao)
  totalEarned     Float    @default(0) // Tổng tiền đã kiếm được
  totalSpent      Float    @default(0) // Tổng tiền đã dùng mua hàng
  updatedAt       DateTime @updatedAt
  
  customer        Customer @relation(fields: [customerId], references: [id])
  transactions    WalletTransaction[]

  @@map("wallets")
}

model WalletTransaction {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  walletId        String   @db.ObjectId
  amount          Float    // Số tiền (dương = cộng, âm = trừ)
  type            WalletTransactionType
  status          WalletTransactionStatus @default(COMPLETED)
  description     String?
  relatedOrderId  String?  @db.ObjectId
  metadata        Json?    // Extra data (bank info for withdrawal, etc.)
  createdAt       DateTime @default(now())
  
  wallet          Wallet   @relation(fields: [walletId], references: [id])

  @@map("wallet_transactions")
  @@index([walletId])
  @@index([type])
  @@index([status])
}

enum WalletTransactionStatus {
  PENDING     // Đang chờ xử lý (withdrawal)
  COMPLETED   // Đã hoàn thành
  REJECTED    // Đã từ chối
  CANCELLED   // Đã hủy
}

enum WalletTransactionType {
  COMMISSION      // Hoa hồng từ giới thiệu (Affiliate)
  ORDER_PAYMENT   // Dùng ví thanh toán đơn hàng
  WITHDRAWAL      // Rút tiền khỏi hệ thống
  REFUND          // Hoàn tiền đơn hàng vào ví
  ESCROW_RELEASE  // Giải ngân từ hợp đồng thầu
  ADJUSTMENT      // Điều chỉnh từ Admin
}

// ============================================
// INTEGRITY SUITE - HỆ THỐNG GIÁM SÁT & MINH BẠCH
// ============================================

// Layer 1: Audit Log - Truy vết mọi hành động nhạy cảm
model AuditLog {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Who did it
  actorId       String?  @db.ObjectId    // User ID who performed action
  actorEmail    String?                   // Email for reference (in case user deleted)
  actorRole     String?                   // Role at time of action
  actorIp       String?                   // IP address
  actorDevice   String?                   // Device/browser info
  
  // What happened
  action        AuditAction               // Type of action
  entityType    String                    // Target entity type (Customer, Order, Wallet, etc.)
  entityId      String?  @db.ObjectId     // Target entity ID
  
  // Change details
  oldValue      Json?                     // Previous value (for updates)
  newValue      Json?                     // New value
  changes       Json?                     // Structured diff of changes
  
  // Context
  reason        String?                   // Reason provided (if any)
  metadata      Json?                     // Additional context data
  
  // Severity
  severity      AuditSeverity @default(INFO)
  
  createdAt     DateTime @default(now())

  @@map("audit_logs")
  @@index([actorId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([severity])
  @@index([createdAt])
}

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PASSWORD_RESET
  
  // User Management
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  USER_BAN
  USER_UNBAN
  ROLE_CHANGE
  
  // KYC & Verification
  KYC_SUBMIT
  KYC_APPROVE
  KYC_REJECT
  VERIFICATION_CHANGE
  
  // Financial
  CREDIT_LIMIT_CHANGE
  CREDIT_APPROVAL
  CREDIT_HOLD
  WALLET_DEPOSIT
  WALLET_WITHDRAWAL
  WALLET_ADJUSTMENT
  ESCROW_DEPOSIT
  ESCROW_RELEASE
  
  // Contractor
  CONTRACTOR_VERIFY
  CONTRACTOR_SUSPEND
  BANK_ACCOUNT_CHANGE
  QUOTE_SUBMIT
  QUOTE_ACCEPT
  
  // Order & Project
  ORDER_CREATE
  ORDER_CANCEL
  ORDER_REFUND
  PROJECT_CREATE
  PROJECT_ASSIGN

  // Admin Actions
  ADMIN_OVERRIDE
  SYSTEM_ALERT_RESOLVE
  CONFIG_CHANGE
}

enum AuditSeverity {
  INFO        // Normal operations
  NOTICE      // Notable but expected
  WARNING     // Potentially concerning
  CRITICAL    // Requires immediate attention
}

// Layer 2: KYC Documents - Xác minh danh tính
model KYCDocument {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String        @db.ObjectId
  
  // Document Info
  documentType    KYCDocumentType
  documentNumber  String?                   // ID number, tax code, etc.
  frontImageUrl   String                    // Front of ID/license
  backImageUrl    String?                   // Back (if applicable)
  selfieUrl       String?                   // Selfie with ID
  
  // Business docs (for contractors)
  businessLicenseUrl  String?             // Giấy phép kinh doanh
  taxCertificateUrl   String?             // Giấy chứng nhận MST
  
  // Verification
  status          KYCStatus     @default(PENDING)
  verifiedBy      String?       @db.ObjectId  // Admin who verified
  verifiedAt      DateTime?
  rejectionReason String?
  
  // Metadata
  expiryDate      DateTime?                 // Document expiry
  extractedData   Json?                     // OCR/AI extracted data
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("kyc_documents")
  @@index([customerId])
  @@index([status])
  @@index([documentType])
}

enum KYCDocumentType {
  CCCD            // Căn cước công dân
  CMND            // Chứng minh nhân dân (old)
  PASSPORT
  BUSINESS_LICENSE   // Giấy phép kinh doanh
  TAX_CERTIFICATE    // Đăng ký thuế
  CONTRACTOR_LICENSE // Chứng chỉ hành nghề
}

enum KYCStatus {
  PENDING         // Chờ xử lý
  REVIEWING       // Đang xem xét
  APPROVED        // Đã duyệt
  REJECTED        // Từ chối
  EXPIRED         // Hết hạn
}

// Layer 3: Suspicious Activity Detection - Phát hiện bất thường
model SuspiciousActivity {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  
  // Who
  userId          String?       @db.ObjectId
  customerId      String?       @db.ObjectId
  sessionId       String?                     // For guest tracking
  ipAddress       String?
  deviceFingerprint String?
  
  // What
  activityType    SuspiciousActivityType
  description     String
  evidence        Json?                       // Supporting data
  
  // Related entities
  relatedEntityType String?                   // Order, Quote, Project, etc.
  relatedEntityId   String?       @db.ObjectId
  
  // Linked accounts (for multi-account detection)
  linkedUserIds   String[]      @db.ObjectId
  linkedIps       String[]
  
  // Risk assessment
  riskScore       Float         @default(0)   // 0-100
  severity        AlertSeverity @default(LOW)
  
  // Resolution
  status          AlertStatus   @default(OPEN)
  resolvedBy      String?       @db.ObjectId
  resolvedAt      DateTime?
  resolution      String?                     // Action taken
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("suspicious_activities")
  @@index([userId])
  @@index([customerId])
  @@index([ipAddress])
  @@index([activityType])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

enum SuspiciousActivityType {
  MULTI_ACCOUNT           // Nhiều tài khoản từ cùng IP/thiết bị
  COLLUSION_BIDDING       // Thông đồng đấu thầu
  FAKE_REVIEWS            // Đánh giá ảo
  RAPID_WITHDRAWALS       // Rút tiền liên tục bất thường
  UNUSUAL_TRANSACTION     // Giao dịch bất thường
  LOGIN_ANOMALY           // Đăng nhập từ vị trí lạ
  PRICE_MANIPULATION      // Thao túng giá
  IDENTITY_MISMATCH       // Thông tin không khớp
  PAYMENT_FRAUD           // Thanh toán gian lận
  OTHER
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  FALSE_POSITIVE
  ESCALATED
}

// Layer 4: User Restrictions - Cấm vận đa cấp độ
model UserRestriction {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String        @db.ObjectId
  
  // Restriction Type
  type            RestrictionType
  reason          String
  evidence        Json?                       // Supporting evidence
  
  // Duration
  isActive        Boolean       @default(true)
  startDate       DateTime      @default(now())
  endDate         DateTime?                   // null = permanent
  
  // Who imposed
  imposedBy       String        @db.ObjectId  // Admin/System ID
  imposedByName   String?
  
  // Appeal
  appealStatus    AppealStatus  @default(NONE)
  appealReason    String?
  appealReviewedBy String?      @db.ObjectId
  appealReviewedAt DateTime?
  
  // Audit
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  liftedAt        DateTime?
  liftedBy        String?       @db.ObjectId
  liftReason      String?

  @@map("user_restrictions")
  @@index([customerId])
  @@index([type])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

enum RestrictionType {
  FULL_BAN            // Cấm hoàn toàn
  MARKETPLACE_BAN     // Cấm nhận dự án/báo giá
  WALLET_HOLD         // Tạm dừng rút tiền (điều tra)
  CREDIT_FREEZE       // Khóa tín dụng
  REVIEW_BAN          // Cấm đánh giá
  BIDDING_BAN         // Cấm đấu thầu
  COMMUNICATION_BAN   // Cấm chat
  PROBATION           // Thời gian thử thách (theo dõi)
}

enum AppealStatus {
  NONE
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

// Device/Session tracking for anomaly detection
model DeviceSession {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  userId          String?       @db.ObjectId
  customerId      String?       @db.ObjectId
  
  // Device info
  fingerprint     String                      // Device fingerprint hash
  userAgent       String
  platform        String?                     // Windows, Mac, iOS, Android
  browser         String?
  
  // Location
  ipAddress       String
  city            String?
  country         String?
  
  // Session
  sessionToken    String?
  lastActiveAt    DateTime      @default(now())
  
  // Trust
  isTrusted       Boolean       @default(false)  // User marked as trusted
  trustScore      Float         @default(50)     // 0-100
  
  createdAt       DateTime      @default(now())

  @@map("device_sessions")
  @@index([userId])
  @@index([customerId])
  @@index([fingerprint])
  @@index([ipAddress])
  @@index([lastActiveAt])
}

// ============================================
// ENTERPRISE FEATURES
// ============================================

// Feature 1: E-Invoice (Hóa đơn điện tử VAT)
model EInvoice {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  
  // Reference
  invoiceId       String?       @db.ObjectId    // Link to internal Invoice
  orderId         String?       @db.ObjectId
  quoteId         String?       @db.ObjectId
  
  // Invoice Info
  invoiceNumber   String        @unique         // Số hóa đơn từ nhà cung cấp
  invoiceSeries   String?                       // Ký hiệu (e.g., 1C24TDK)
  templateCode    String?                       // Mẫu hóa đơn
  
  // Seller Info
  sellerTaxCode   String                        // MST người bán (cửa hàng)
  sellerName      String
  sellerAddress   String?
  
  // Buyer Info
  buyerTaxCode    String?                       // MST người mua (nếu có)
  buyerName       String
  buyerAddress    String?
  buyerEmail      String?
  
  // Amounts
  subtotal        Float
  vatRate         Float         @default(10)    // 0, 5, 8, 10%
  vatAmount       Float
  totalAmount     Float
  currency        String        @default("VND")
  
  // E-Invoice Provider
  provider        EInvoiceProvider @default(INTERNAL)
  providerInvoiceId String?                     // ID từ nhà cung cấp (Misa, Viettel...)
  providerResponse Json?                        // Response data từ provider
  
  // Status
  status          EInvoiceStatus @default(DRAFT)
  signedAt        DateTime?
  sentAt          DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  
  // Files
  pdfUrl          String?                       // URL file PDF hóa đơn
  xmlUrl          String?                       // URL file XML
  
  // Audit
  createdBy       String?       @db.ObjectId
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("e_invoices")
  @@index([orderId])
  @@index([buyerTaxCode])
  @@index([status])
  @@index([createdAt])
}

enum EInvoiceProvider {
  INTERNAL        // Nội bộ (không gửi đi)
  MISA            // Misa meInvoice
  VIETTEL         // Viettel S-Invoice
  VNPT            // VNPT E-Invoice
  FPT             // FPT.eInvoice
  BKAV            // BKAV eHoadon
}

enum EInvoiceStatus {
  DRAFT           // Nháp
  PENDING_SIGN    // Chờ ký số
  SIGNED          // Đã ký
  SENT            // Đã gửi cho khách
  CANCELLED       // Đã hủy
  REPLACED        // Đã thay thế (xuất hóa đơn mới)
}

// Feature 2: E-Contract (Hợp đồng điện tử có pháp lý)
model EContract {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  
  // Reference
  quoteId         String?       @db.ObjectId
  projectId       String?       @db.ObjectId
  orderId         String?       @db.ObjectId
  
  // Contract Info
  contractNumber  String        @unique
  title           String
  description     String?
  contractType    EContractType
  
  // Parties
  partyA          Json                          // {name, taxCode, address, representative, role}
  partyB          Json                          // {name, taxCode, address, representative, role}
  
  // Value & Terms
  totalValue      Float
  currency        String        @default("VND")
  startDate       DateTime
  endDate         DateTime?
  paymentTerms    String?
  
  // Content
  templateId      String?                       // Template được sử dụng
  contentHtml     String?                       // Nội dung HTML
  clauses         Json?                         // Các điều khoản {id, title, content}[]
  
  // Signatures
  signatureStatus EContractSignStatus @default(PENDING)
  partyASignedAt  DateTime?
  partyASignature Json?                         // {method, signatureData, ipAddress, timestamp}
  partyBSignedAt  DateTime?
  partyBSignature Json?
  
  // Digital Signature (CA)
  usesDigitalCert Boolean       @default(false)
  certSerialNumber String?                      // Serial chứng thư số
  certProvider    String?                       // Nhà cung cấp CA (VNPT-CA, Viettel-CA, etc.)
  
  // Files
  pdfUrl          String?                       // URL hợp đồng PDF
  signedPdfUrl    String?                       // URL hợp đồng đã ký
  
  // Status
  status          EContractStatus @default(DRAFT)
  effectiveDate   DateTime?                     // Ngày có hiệu lực
  terminatedAt    DateTime?
  terminationReason String?
  
  // Audit
  createdBy       String        @db.ObjectId
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("e_contracts")
  @@index([quoteId])
  @@index([projectId])
  @@index([status])
  @@index([signatureStatus])
}

enum EContractType {
  SERVICE         // Hợp đồng dịch vụ thi công
  SUPPLY          // Hợp đồng cung cấp vật tư
  CONSTRUCTION    // Hợp đồng xây dựng
  MAINTENANCE     // Hợp đồng bảo trì
  FRAMEWORK       // Hợp đồng khung (nhiều đơn hàng)
}

enum EContractSignStatus {
  PENDING         // Chờ ký
  PARTY_A_SIGNED  // Bên A đã ký
  PARTY_B_SIGNED  // Bên B đã ký
  FULLY_SIGNED    // Đã ký đủ
  REJECTED        // Từ chối ký
}

enum EContractStatus {
  DRAFT           // Nháp
  PENDING_REVIEW  // Chờ xem xét
  PENDING_SIGN    // Chờ ký
  ACTIVE          // Đang có hiệu lực
  COMPLETED       // Đã hoàn thành
  TERMINATED      // Đã chấm dứt
  EXPIRED         // Hết hạn
}

// Feature 3: Project Insurance (Bảo hiểm công trình)
model ProjectInsurance {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  
  // Reference
  projectId       String?       @db.ObjectId
  quoteId         String?       @db.ObjectId
  contractId      String?       @db.ObjectId    // Link to EContract
  
  // Policy Info
  policyNumber    String        @unique
  insurerName     String                        // Tên công ty bảo hiểm
  insurerCode     String?                       // Mã đại lý/công ty
  
  // Coverage
  insuranceType   InsuranceType
  coverageAmount  Float                         // Số tiền bảo hiểm tối đa
  deductible      Float         @default(0)     // Mức khấu trừ
  premium         Float                         // Phí bảo hiểm
  
  // Period
  effectiveDate   DateTime
  expiryDate      DateTime
  
  // Insured Party
  insuredName     String
  insuredTaxCode  String?
  insuredAddress  String?
  
  // Beneficiary (người thụ hưởng)
  beneficiaryName String?
  beneficiaryInfo Json?
  
  // Status
  status          InsuranceStatus @default(PENDING)
  approvedAt      DateTime?
  claimCount      Int           @default(0)
  totalClaimAmount Float        @default(0)
  
  // Documents
  policyDocUrl    String?                       // URL file hợp đồng bảo hiểm
  certificateUrl  String?                       // URL giấy chứng nhận
  
  // Claims
  claims          InsuranceClaim[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("project_insurances")
  @@index([projectId])
  @@index([status])
  @@index([expiryDate])
}

model InsuranceClaim {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  insuranceId     String        @db.ObjectId
  
  // Claim Info
  claimNumber     String        @unique
  incidentDate    DateTime
  reportDate      DateTime      @default(now())
  description     String
  
  // Damage
  damageType      String                        // Thiệt hại vật chất, tai nạn lao động, etc.
  estimatedLoss   Float
  claimAmount     Float                         // Số tiền yêu cầu bồi thường
  approvedAmount  Float?                        // Số tiền được duyệt
  
  // Evidence
  photos          String[]                      // URLs ảnh chứng cứ
  documents       String[]                      // URLs tài liệu
  witnessInfo     Json?                         // Thông tin nhân chứng
  
  // Status
  status          ClaimStatus   @default(SUBMITTED)
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?
  paidAt          DateTime?
  
  // Relationship
  insurance       ProjectInsurance @relation(fields: [insuranceId], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("insurance_claims")
  @@index([insuranceId])
  @@index([status])
}

enum InsuranceType {
  CONSTRUCTION_ALL_RISK   // Bảo hiểm mọi rủi ro xây dựng (CAR)
  LIABILITY               // Bảo hiểm trách nhiệm dân sự
  WORKERS_COMPENSATION    // Bảo hiểm tai nạn lao động
  EQUIPMENT               // Bảo hiểm thiết bị máy móc
  MATERIAL_TRANSIT        // Bảo hiểm vận chuyển vật liệu
  PROFESSIONAL_INDEMNITY  // Bảo hiểm trách nhiệm nghề nghiệp
}

enum InsuranceStatus {
  PENDING         // Đang chờ duyệt
  ACTIVE          // Đang có hiệu lực
  EXPIRED         // Hết hạn
  CANCELLED       // Đã hủy
  CLAIMED         // Đã có claim
}

enum ClaimStatus {
  SUBMITTED       // Đã gửi
  UNDER_REVIEW    // Đang xem xét
  APPROVED        // Đã duyệt
  REJECTED        // Từ chối
  PAID            // Đã thanh toán
  CLOSED          // Đã đóng
}

// Feature 4: Delivery Phases (Giao hàng theo giai đoạn)
model DeliveryPhase {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String        @db.ObjectId
  
  // Phase Info
  phaseNumber     Int                           // Đợt 1, 2, 3...
  phaseName       String                        // "Giai đoạn móng", "Giai đoạn hoàn thiện"
  description     String?
  
  // Items in this phase
  items           Json                          // [{productId, quantity, unitPrice}]
  itemCount       Int           @default(0)
  
  // Value
  phaseValue      Float                         // Giá trị đợt giao
  depositRequired Float         @default(0)     // Tiền cọc yêu cầu cho đợt này
  
  // Schedule
  scheduledDate   DateTime                      // Ngày dự kiến giao
  actualDate      DateTime?                     // Ngày giao thực tế
  
  // Status
  status          DeliveryPhaseStatus @default(PENDING)
  
  // Payment (linked to Escrow)
  paymentStatus   PhasePaymentStatus @default(UNPAID)
  depositPaidAt   DateTime?
  releasedAt      DateTime?                     // Tiền được giải ngân lúc nào
  
  // Delivery tracking
  trackingNumber  String?
  carrierName     String?
  deliveryProof   String?                       // URL ảnh xác nhận giao hàng
  receiverName    String?
  receiverSignature String?                     // URL chữ ký người nhận
  
  // Confirmation
  confirmedBy     String?       @db.ObjectId    // Khách hàng xác nhận
  confirmedAt     DateTime?
  
  // Relationship
  order           Order         @relation(fields: [orderId], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("delivery_phases")
  @@index([orderId])
  @@index([status])
  @@index([scheduledDate])
  @@index([paymentStatus])
}

enum DeliveryPhaseStatus {
  PENDING         // Chờ xử lý
  PREPARING       // Đang chuẩn bị hàng
  READY           // Sẵn sàng giao
  IN_TRANSIT      // Đang vận chuyển
  DELIVERED       // Đã giao
  CONFIRMED       // Khách đã xác nhận
  CANCELLED       // Đã hủy
}

enum PhasePaymentStatus {
  UNPAID          // Chưa thanh toán
  DEPOSIT_PAID    // Đã đặt cọc
  ESCROWED        // Tiền đã vào Escrow
  RELEASED        // Đã giải ngân cho nhà cung cấp/thầu
  REFUNDED        // Đã hoàn tiền
}

// Feature 5: Sensitive Data Encryption Tracking (PDPA Compliance)
model SensitiveDataLog {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  
  // What data
  dataType        SensitiveDataType
  entityType      String                        // Customer, KYCDocument, etc.
  entityId        String        @db.ObjectId
  fieldName       String                        // cccdNumber, bankAccountNumber, etc.
  
  // Encryption
  encryptionKey   String?                       // Key ID (không lưu key thật)
  encryptedAt     DateTime      @default(now())
  algorithm       String        @default("AES-256-GCM")
  
  // Access log
  lastAccessedBy  String?       @db.ObjectId
  lastAccessedAt  DateTime?
  accessCount     Int           @default(0)
  
  // Compliance
  retentionDays   Int           @default(365)   // Thời gian lưu trữ
  expiresAt       DateTime?                     // Ngày phải xóa
  deletedAt       DateTime?
  deletionReason  String?

  @@map("sensitive_data_logs")
  @@index([entityType, entityId])
  @@index([dataType])
  @@index([expiresAt])
}

enum SensitiveDataType {
  CCCD_NUMBER           // Số CCCD
  CMND_NUMBER           // Số CMND
  PASSPORT_NUMBER       // Số hộ chiếu
  TAX_CODE              // Mã số thuế
  BANK_ACCOUNT          // Số tài khoản ngân hàng
  PHONE_NUMBER          // Số điện thoại
  ADDRESS               // Địa chỉ
  KYC_IMAGE             // Ảnh KYC (CCCD, selfie)
  SIGNATURE             // Chữ ký
}


// ============================================
// SUPPLIER PORTAL EXTENSIONS
// ============================================

// Quản lý khuyến mãi từ NCC
model SupplierPromotion {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  supplierId      String   @db.ObjectId
  name            String
  description     String?
  discountPercent Float?   // Giảm theo %
  discountAmount  Float?   // Giảm theo số tiền
  minOrderAmount  Float    @default(0)
  startDate       DateTime
  endDate         DateTime
  status          PromotionStatus @default(PENDING) // PENDING, APPROVED, REJECTED, ACTIVE, EXPIRED
  appliedProducts String[] @db.ObjectId // List of product IDs applied
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supplier        Supplier @relation(fields: [supplierId], references: [id])

  @@map("supplier_promotions")
  @@index([supplierId])
  @@index([status])
}

enum PromotionStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  EXPIRED
}

// Quản lý hàng trả về từ PO
model PurchaseReturn {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  purchaseOrderId String   @db.ObjectId
  supplierId      String   @db.ObjectId
  reason          String
  status          ReturnStatus @default(PENDING) // PENDING, RECEIVED, REFUNDED, CANCELLED
  totalRefundAmount Float  @default(0)
  evidenceUrls    String[]
  processingMethod String? // REFUND, DEBT_DEDUCTION, REPLACEMENT
  items           PurchaseReturnItem[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  supplier        Supplier      @relation(fields: [supplierId], references: [id])

  @@map("purchase_returns")
  @@index([purchaseOrderId])
  @@index([supplierId])
}

model PurchaseReturnItem {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  returnId        String   @db.ObjectId
  productId       String   @db.ObjectId
  quantity        Float
  unitPrice       Float
  reason          String?
  condition       String? // Mới, Lỗi, Đã khui, ...

  purchaseReturn  PurchaseReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  product         Product        @relation(fields: [productId], references: [id])

  @@map("purchase_return_items")
}

enum ReturnStatus {
  PENDING
  RECEIVED
  REFUNDED
  CANCELLED
}

// Quản lý chứng từ NCC
model SupplierDocument {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  supplierId      String   @db.ObjectId
  name            String   // GPKD, CO/CQ, Hợp đồng, v.v.
  type            String   // PDF, IMAGE
  fileUrl         String
  status          DocumentStatus @default(PENDING) // PENDING, VERIFIED, REJECTED, EXPIRED
  expiryDate      DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supplier        Supplier @relation(fields: [supplierId], references: [id])

  @@map("supplier_documents")
  @@index([supplierId])
  @@index([status])
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

// ============================================
// B2B ORGANIZATIONS FLOW
// ============================================

model Organization {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  taxCode     String?
  address     String?
  logo        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     OrganizationMember[]
  customers   Customer[]
  orders      Order[]
  projects    ConstructionProject[]
  managedProjects Project[]
  invitations OrganizationInvitation[]
  
  @@map("organizations")
}

model OrganizationMember {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String   @db.ObjectId
  userId         String   @db.ObjectId
  role           OrganizationRole @default(BUYER)
  joinedAt       DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@map("organization_members")
}

enum OrganizationRole {
  OWNER
  ADMIN
  BUYER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model OrganizationInvitation {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String           @db.ObjectId
  email           String
  role            OrganizationRole @default(BUYER)
  intendedUserRole UserRole        @default(CUSTOMER)
  invitedById     String           @db.ObjectId
  status          InvitationStatus @default(PENDING)
  token           String           @unique
  expiresAt       DateTime
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  organization    Organization     @relation(fields: [organizationId], references: [id])
  invitedBy       User             @relation(fields: [invitedById], references: [id])

  @@unique([organizationId, email])
  @@map("organization_invitations")
}

enum B2BApprovalStatus {
  NOT_REQUIRED
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum WarehouseRackType {
  RACK
  OPEN_YARD
  SILO
  TANK
  ZONE
}

enum WarehouseBinType {
  SHELF_BIN
  PILE
  TANK_STORAGE
  AREA
}

// ============================================
// WAREHOUSE MANAGEMENT SYSTEM (WMS)
// ============================================

model WarehouseRack {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // Rack A1, Shelf B2
  description String?
  warehouse   String   @default("Main Warehouse")
  type        WarehouseRackType @default(RACK)
  bins        WarehouseBin[]

  @@map("warehouse_racks")
}

model WarehouseBin {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  rackId      String   @db.ObjectId
  code        String   // A1-01, B2-05
  capacity    Float?
  type        WarehouseBinType @default(SHELF_BIN)
  isActive    Boolean  @default(true)

  rack        WarehouseRack @relation(fields: [rackId], references: [id])
  stockItems  InventoryBinLink[]

  @@unique([rackId, code])
  @@map("warehouse_bins")
}

model InventoryBinLink {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  inventoryItemId String   @db.ObjectId
  binId           String   @db.ObjectId
  quantity        Float    @default(0)

  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  bin             WarehouseBin  @relation(fields: [binId], references: [id])

  @@unique([inventoryItemId, binId])
  @@map("inventory_bin_links")
}

// ============================================
// CUSTOMER RETURNS FLOW
// ============================================

model CustomerReturn {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String   @db.ObjectId
  customerId      String   @db.ObjectId
  reason          String
  description     String?
  status          CustomerReturnStatus @default(PENDING)
  refundAmount    Float    @default(0)
  evidenceUrls    String[]
  adminNotes      String?
  resolvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  order           Order    @relation(fields: [orderId], references: [id])
  customer        Customer @relation(fields: [customerId], references: [id])
  items           CustomerReturnItem[]

  @@map("customer_returns")
}

model CustomerReturnItem {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  returnId        String   @db.ObjectId
  productId       String   @db.ObjectId
  quantity        Float
  unitPrice       Float

  customerReturn  CustomerReturn @relation(fields: [returnId], references: [id])
  product         Product        @relation(fields: [productId], references: [id])

  @@map("customer_return_items")
}

model Lead {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String?
  phone           String?
  email           String?
  projectType     String?
  estimateData    Json?    // Store the raw AI result if available
  source          String   @default("AI_ESTIMATOR")
  status          String   @default("NEW") // NEW, CONTACTED, CONVERTED, CLOSED
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("leads")
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}


enum CustomerReturnStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}



