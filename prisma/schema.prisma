// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole @default(CUSTOMER)
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  employee Employee?
  customer Customer?
  notifications Notification[]

  @@map("users")
  @@index([email])
  @@index([role])
}

model Employee {
  id           String   @id @default(cuid())
  userId       String   @unique
  employeeCode String   @unique
  department   String
  position     String
  baseSalary   Float
  hireDate     DateTime
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workShifts     WorkShift[]
  salaryAdvances SalaryAdvance[]
  payrollRecords PayrollRecord[]
  tasks          EmployeeTask[]
  assignedProjectTasks ProjectTask[] @relation("ProjectTaskAssignee")

  @@map("employees")
  @@index([userId])
  @@index([employeeCode])
  @@index([department])
  @@index([isActive])
}

model Customer {
  id              String       @id @default(cuid())
  userId          String       @unique
  customerType    CustomerType @default(REGULAR)
  totalPurchases  Float        @default(0)
  loyaltyPoints   Int          @default(0)
  creditLimit     Float        @default(0)
  currentBalance  Float        @default(0)
  preferredPayment String?
  
  // Loyalty Program Fields
  loyaltyTier     LoyaltyTier  @default(BRONZE)
  loyaltyPointsToNextTier Int  @default(1000) // Points needed to reach next tier
  totalPointsEarned Int       @default(0)     // Lifetime points earned
  totalPointsRedeemed Int     @default(0)     // Lifetime points redeemed
  lastPurchaseDate DateTime?                 // For activity tracking
  purchaseFrequency Float      @default(0)     // Average purchases per month
  preferredCategories String[]               // Categories customer buys most
  birthday        DateTime?                  // For special promotions
  anniversaryDate DateTime?                  // Customer since date
  referralCode    String?     @unique        // For referral program
  referredBy      String?                    // Who referred this customer
  totalReferrals  Int         @default(0)    // Number of people they've referred
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relationships
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders  Order[]
  invoices Invoice[]
  projects Project[]
  referrals Customer[] @relation("CustomerReferral")
  referredByCustomer Customer? @relation("CustomerReferral", fields: [referredBy], references: [id])
  materialCalculations MaterialCalculation[]

  @@map("customers")
  @@index([userId])
  @@index([customerType])
  @@index([loyaltyTier])
  @@index([totalPointsEarned])
  @@index([lastPurchaseDate])
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

// Work Shift and Attendance
model WorkShift {
  id         String      @id @default(cuid())
  employeeId String
  date       DateTime
  startTime  String
  endTime    String
  shiftType  ShiftType   @default(REGULAR)
  status     ShiftStatus @default(SCHEDULED)
  clockIn    DateTime?
  clockOut   DateTime?
  breakTime  Int         @default(0) // minutes
  overtime   Int         @default(0) // minutes
  notes      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("work_shifts")
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([shiftType])
}

model EmployeeTask {
  id          String     @id @default(cuid())
  employeeId  String
  title       String
  description String?
  taskType    TaskType   @default(GENERAL)
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  estimatedHours Float?
  actualHours    Float?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("employee_tasks")
  @@index([employeeId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([taskType])
}

// Payroll Management
model SalaryAdvance {
  id          String        @id @default(cuid())
  employeeId  String
  amount      Float
  reason      String
  requestDate DateTime      @default(now())
  approvedBy  String?
  approvedAt  DateTime?
  status      AdvanceStatus @default(PENDING)
  repaymentPeriod Int       @default(1) // months
  isRepaid    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("salary_advances")
  @@index([employeeId])
  @@index([status])
  @@index([requestDate])
}

model PayrollRecord {
  id            String   @id @default(cuid())
  employeeId    String
  period        String   // YYYY-MM format
  baseSalary    Float
  bonuses       Float    @default(0)
  penalties     Float    @default(0)
  overtime      Float    @default(0)
  totalAdvances Float    @default(0)
  grossPay      Float
  taxDeductions Float    @default(0)
  otherDeductions Float  @default(0)
  netPay        Float
  hoursWorked   Float    @default(0)
  overtimeHours Float    @default(0)
  isPaid        Boolean  @default(false)
  paidAt        DateTime?
  generatedAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, period])
  @@map("payroll_records")
  @@index([employeeId])
  @@index([period])
  @@index([isPaid])
  @@index([generatedAt])
}

// Product and Inventory Management
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  parentId    String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
}

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  categoryId  String
  sku         String  @unique
  price       Float
  costPrice   Float?
  unit        String  @default("pcs")
  weight      Float?
  dimensions  String?
  images      String[]
  tags        String[]
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  category         Category           @relation(fields: [categoryId], references: [id])
  inventoryItem    InventoryItem?
  orderItems       OrderItem[]
  invoiceItems     InvoiceItem[]
  purchaseItems    PurchaseItem[]
  inventoryMovements InventoryMovement[]
  productReviews   ProductReview[]
  projectMaterials ProjectMaterial[]
  projectTaskMaterials ProjectTaskMaterial[]
  inventoryPredictions InventoryPrediction[]
  inventoryHistory InventoryHistory[]

  @@map("products")
  @@index([categoryId])
  @@index([name])
  @@index([sku])
  @@index([isActive])
  @@index([isFeatured])
  @@index([price])
  @@index([createdAt])
  @@index([categoryId, isActive])
  @@index([isFeatured, isActive])
}

model InventoryItem {
  id               String    @id @default(cuid())
  productId        String    @unique
  quantity         Float     @default(0)
  reservedQuantity Float     @default(0)
  availableQuantity Float    @default(0)
  minStockLevel    Float     @default(0)
  maxStockLevel    Float?
  reorderPoint     Float     @default(0)
  lastStockDate    DateTime?
  lastCountDate    DateTime?
  location         String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relationships
  product   Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  movements InventoryMovement[]

  @@map("inventory_items")
  @@index([productId])
  @@index([availableQuantity])
  @@index([minStockLevel])
  @@index([reorderPoint])
}

model InventoryMovement {
  id            String       @id @default(cuid())
  productId     String
  inventoryId   String
  movementType  MovementType
  quantity      Float
  previousStock Float
  newStock      Float
  reason        String
  referenceType String?      // ORDER, PURCHASE, ADJUSTMENT, etc.
  referenceId   String?
  performedBy   String
  notes         String?
  createdAt     DateTime     @default(now())

  // Relationships
  product       Product       @relation(fields: [productId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryId], references: [id])

  @@map("inventory_movements")
  @@index([productId])
  @@index([inventoryId])
  @@index([movementType])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

// Order Management
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  customerId      String?
  customerType    OrderCustomerType @default(REGISTERED)
  guestEmail      String?
  guestPhone      String?
  guestName       String?
  status          OrderStatus @default(PENDING_CONFIRMATION)
  totalAmount     Float
  taxAmount       Float       @default(0)
  shippingAmount  Float       @default(0)
  discountAmount  Float       @default(0)
  netAmount       Float
  paymentMethod   String?
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Deposit Payment Fields
  paymentType     OrderPaymentType @default(FULL)
  depositPercentage Int?         // 30, 40, 50
  depositAmount   Float?
  remainingAmount Float?
  depositPaidAt   DateTime?
  depositProof    String?       // URL to payment proof image
  qrExpiresAt     DateTime?     // QR code expiration time
  
  shippingAddress Json?
  billingAddress  Json?
  notes           String?
  expectedDelivery DateTime?
  actualDelivery   DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  confirmedBy     String?       // Admin who confirmed the order
  confirmedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relationships
  customer     Customer?   @relation(fields: [customerId], references: [id])
  orderItems   OrderItem[]
  invoices     Invoice[]
  orderTracking OrderTracking[]

  @@map("orders")
  @@index([orderNumber])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@index([customerType])
  @@index([paymentStatus])
  @@index([paymentType])
  @@index([qrExpiresAt])
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  discount    Float   @default(0)
  notes       String?
  createdAt   DateTime @default(now())

  // Relationships
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
  @@index([orderId])
  @@index([productId])
  @@index([createdAt])
}

model OrderTracking {
  id          String   @id @default(cuid())
  orderId     String
  status      OrderStatus
  description String
  location    String?
  timestamp   DateTime @default(now())
  createdBy   String?

  // Relationships
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_tracking")
  @@index([orderId])
  @@index([status])
  @@index([timestamp])
}

// Invoice Management
model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  invoiceType   InvoiceType
  orderId       String?
  customerId    String?
  supplierId    String?
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  status        InvoiceStatus @default(DRAFT)
  subtotal      Float
  taxAmount     Float         @default(0)
  discountAmount Float        @default(0)
  totalAmount   Float
  paidAmount    Float         @default(0)
  balanceAmount Float         @default(0)
  paymentTerms  String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relationships
  order        Order?          @relation(fields: [orderId], references: [id])
  customer     Customer?       @relation(fields: [customerId], references: [id])
  supplier     Supplier?       @relation(fields: [supplierId], references: [id])
  invoiceItems InvoiceItem[]
  payments     Payment[]

  @@map("invoices")
  @@index([invoiceNumber])
  @@index([customerId])
  @@index([supplierId])
  @@index([status])
  @@index([issueDate])
  @@index([invoiceType])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  productId   String
  description String?
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  discount    Float   @default(0)
  taxRate     Float   @default(0)
  taxAmount   Float   @default(0)

  // Relationships
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
  @@index([invoiceId])
  @@index([productId])
}

// Supplier Management
model Supplier {
  id            String   @id @default(cuid())
  name          String
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  city          String?
  country       String?
  taxId         String?
  paymentTerms  String?
  creditLimit   Float    @default(0)
  currentBalance Float   @default(0)
  rating        Int?     @default(0)
  isActive      Boolean  @default(true)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  invoices      Invoice[]
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
  @@index([name])
  @@index([isActive])
}

model PurchaseOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique
  supplierId      String
  status          PurchaseOrderStatus @default(DRAFT)
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?
  receivedDate    DateTime?
  totalAmount     Float
  taxAmount       Float               @default(0)
  shippingAmount  Float               @default(0)
  discountAmount  Float               @default(0)
  netAmount       Float
  notes           String?
  createdBy       String
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relationships
  supplier      Supplier        @relation(fields: [supplierId], references: [id])
  purchaseItems PurchaseItem[]

  @@map("purchase_orders")
  @@index([orderNumber])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

model PurchaseItem {
  id              String  @id @default(cuid())
  purchaseOrderId String
  productId       String
  quantity        Float
  unitPrice       Float
  totalPrice      Float
  receivedQuantity Float  @default(0)
  discount        Float   @default(0)
  notes           String?

  // Relationships
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@map("purchase_items")
  @@index([purchaseOrderId])
  @@index([productId])
}

// Payment Management
model Payment {
  id            String        @id @default(cuid())
  paymentNumber String        @unique
  invoiceId     String?
  orderId       String?
  paymentType   PaymentType
  paymentMethod PaymentMethod
  amount        Float
  currency      String        @default("USD")
  exchangeRate  Float         @default(1.0)
  status        PaymentStatus @default(PENDING)
  transactionId String?
  reference     String?
  paymentDate   DateTime      @default(now())
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relationships
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("payments")
  @@index([paymentNumber])
  @@index([invoiceId])
  @@index([orderId])
  @@index([status])
  @@index([paymentDate])
}

// Product Reviews and Ratings
model ProductReview {
  id         String   @id @default(cuid())
  productId  String
  customerId String
  orderId    String?
  rating     Int      // 1-5 stars
  title      String?
  review     String?
  isVerified Boolean  @default(false)
  isPublished Boolean @default(true)
  helpfulCount Int    @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  product Product @relation(fields: [productId], references: [id])

  @@unique([productId, customerId, orderId])
  @@map("product_reviews")
  @@index([productId])
  @@index([customerId])
  @@index([rating])
  @@index([isPublished])
  @@index([createdAt])
}

// AI and Automation
model OCRProcessing {
  id           String    @id @default(cuid())
  fileName     String
  filePath     String
  extractedText String?
  processedData Json?
  status       OCRStatus @default(PENDING)
  confidence   Float?
  errorMessage String?
  processedBy  String?
  reviewedBy   String?
  reviewedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("ocr_processing")
  @@index([status])
  @@index([createdAt])
  @@index([processedBy])
}

model CustomerInteraction {
  id             String            @id @default(cuid())
  customerId     String?
  sessionId      String
  interactionType InteractionType
  productId      String?
  query          String?
  response       String?
  sentiment      String?
  rating         Int?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime          @default(now())

  @@map("customer_interactions")
  @@index([customerId])
  @@index([sessionId])
  @@index([interactionType])
  @@index([productId])
  @@index([createdAt])
}

model InventoryPrediction {
  id              String   @id @default(cuid())
  productId       String
  predictionDate  DateTime @default(now())
  targetDate      DateTime @default(now()) // Date we're predicting for
  timeframe       String   // WEEK, MONTH, QUARTER
  predictedDemand Float
  confidence      Float    // 0-1
  method          String   @default("LINEAR_REGRESSION") // LINEAR_REGRESSION, ML_MODEL, etc.
  factors         Json?    // trend, seasonality, etc.
  recommendedOrder Float?
  
  // Actual data (filled later for validation)
  actualDemand    Float?
  accuracy        Float?   // 0-100
  error           Float?   // Absolute error
  validatedAt     DateTime?
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  
  product         Product  @relation(fields: [productId], references: [id])

  @@map("inventory_predictions")
  @@index([productId])
  @@index([predictionDate])
  @@index([targetDate])
  @@index([timeframe])
  @@index([confidence])
  @@index([isActive])
}

// Enums
enum UserRole {
  MANAGER
  EMPLOYEE
  CUSTOMER
}

enum CustomerType {
  REGULAR
  VIP
  WHOLESALE
}

enum ShiftType {
  REGULAR
  OVERTIME
  LOADING
  TRANSPORT
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  ABSENT
  CANCELLED
}

enum TaskType {
  GENERAL
  LOADING
  TRANSPORT
  INVENTORY
  SALES
  MAINTENANCE
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AdvanceStatus {
  PENDING
  APPROVED
  REJECTED
  REPAID
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
  DAMAGE
  RETURN
}

enum OrderStatus {
  PENDING_CONFIRMATION      // Chờ admin xác nhận đơn
  CONFIRMED_AWAITING_DEPOSIT // Admin đã xác nhận, chờ khách cọc
  DEPOSIT_PAID             // Đã cọc, đang xử lý
  PENDING                  // Chờ xử lý (cho đơn thanh toán đầy đủ)
  CONFIRMED                // Đã xác nhận
  PROCESSING               // Đang chuẩn bị hàng
  SHIPPED                  // Đang giao hàng
  DELIVERED                // Đã giao hàng
  CANCELLED                // Đã hủy
  RETURNED                 // Đã trả hàng
}

enum OrderCustomerType {
  REGISTERED
  GUEST
}

enum OrderPaymentType {
  FULL      // Thanh toán đầy đủ
  DEPOSIT   // Đặt cọc trước
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum InvoiceType {
  SALES
  PURCHASE
  RETURN
  CREDIT_NOTE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentType {
  INCOMING
  OUTGOING
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHECK
  DIGITAL_WALLET
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  RECEIVED
  CANCELLED
}

enum OCRStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REVIEWED
}

enum InteractionType {
  PRODUCT_VIEW
  PRODUCT_SEARCH
  ADD_TO_CART
  PURCHASE
  CHATBOT
  REVIEW
  SUPPORT
}

// Notifications Model
model Notification {
  id          String     @id @default(cuid())
  userId      String?
  title       String
  message     String
  type        NotificationType @default(INFO)
  priority    Priority   @default(MEDIUM)
  read        Boolean    @default(false)
  referenceId String?
  referenceType String?
  metadata    Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  STOCK_ALERT
  ORDER_UPDATE
  PAYMENT_UPDATE
}

// Project Management
model Project {
  id              String     @id @default(cuid())
  name            String
  description     String?
  customerId      String
  status          ProjectStatus @default(PLANNING)
  startDate       DateTime
  endDate         DateTime?
  budget          Float
  actualCost      Float      @default(0)
  progress        Int        @default(0) // 0-100%
  priority        Priority   @default(MEDIUM)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  customer        Customer   @relation(fields: [customerId], references: [id])
  projectTasks    ProjectTask[]
  projectMaterials ProjectMaterial[]

  @@map("projects")
  @@index([customerId])
  @@index([status])
  @@index([priority])
  @@index([startDate])
}

model ProjectTask {
  id          String     @id @default(cuid())
  projectId   String
  name        String
  description String?
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  assigneeId  String?    // Employee ID
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  estimatedHours Float?
  actualHours    Float?
  progress    Int        @default(0) // 0-100%
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee    Employee?  @relation("ProjectTaskAssignee", fields: [assigneeId], references: [id])
  taskMaterials ProjectTaskMaterial[]

  @@map("project_tasks")
  @@index([projectId])
  @@index([status])
  @@index([priority])
  @@index([assigneeId])
}

model ProjectMaterial {
  id          String   @id @default(cuid())
  projectId   String
  productId   String
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  status      MaterialStatus @default(REQUESTED)
  requestedAt DateTime @default(now())
  deliveredAt DateTime?
  notes       String?

  // Relationships
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@map("project_materials")
  @@index([projectId])
  @@index([productId])
  @@index([status])
}

model ProjectTaskMaterial {
  id          String   @id @default(cuid())
  taskId      String
  productId   String
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  status      MaterialStatus @default(REQUESTED)
  requestedAt DateTime @default(now())
  deliveredAt DateTime?
  notes       String?

  // Relationships
  task        ProjectTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id])

  @@map("project_task_materials")
  @@index([taskId])
  @@index([productId])
  @@index([status])
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum MaterialStatus {
  REQUESTED
  ORDERED
  DELIVERED
  CANCELLED
}

// Material Calculator
model MaterialCalculation {
  id              String   @id @default(cuid())
  customerId      String?
  projectType     String
  projectData     Json     // Store all project inputs
  calculationResult Json   // Store complete calculation results
  totalEstimate   Float
  status          String   @default("DRAFT") // DRAFT, CONFIRMED, ORDERED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@map("material_calculations")
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

// Inventory History (for tracking all changes)
model InventoryHistory {
  id              String   @id @default(cuid())
  productId       String
  changeType      String   // SALE, PURCHASE, ADJUSTMENT, RETURN
  quantityChange  Float    // Can be negative
  quantityBefore  Float?
  quantityAfter   Float
  reason          String?
  referenceId     String?  // Order ID, Purchase Order ID, etc.
  performedBy     String?  // User who made the change
  createdAt       DateTime @default(now())
  
  product         Product  @relation(fields: [productId], references: [id])
  
  @@map("inventory_history")
  @@index([productId])
  @@index([changeType])
  @@index([createdAt])
}