name: ML Services Tasks

on:
  schedule:
    # Keep Render Warm: M·ªói 14 ph√∫t (Render Free tier t·∫Øt sau 15p)
    - cron: '*/14 * * * *'
    
    # Market Trend & Price Scraping: 00:00 (7:00 AM VN) h√†ng ng√†y
    - cron: '0 0 * * *'
    
    # Customer Churn Analysis: 01:00 Ch·ªß Nh·∫≠t h√†ng tu·∫ßn
    - cron: '0 1 * * 0'
    
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng

jobs:
  keep-warm:
    name: Keep ML Services Warm
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/14 * * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Ping ML Health Endpoint
        run: |
          URL="${{ secrets.ML_SERVICES_URL }}"
          if [ -z "$URL" ]; then
            echo "‚ö†Ô∏è ML_SERVICES_URL not set, skipping..."
            exit 0
          fi
          echo "üöÄ Pinging $URL/health"
          curl -f -s "$URL/health" || echo "‚ö†Ô∏è Service might be starting up..."

  market-updates:
    name: Market Trend Updates
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger Market Scraping
        run: |
          URL="${{ secrets.ML_SERVICES_URL }}"
          if [ -z "$URL" ]; then echo "‚ùå ML_SERVICES_URL not set"; exit 1; fi
          
          echo "üìä Triggering Market Trends Update..."
          curl -X POST "$URL/market/trends" \
            -H "Content-Type: application/json" \
            -d '{"category": "all", "period": 30}'

  pricing-optimization:
    name: Daily Dynamic Pricing
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger Price Recommendations
        run: |
          URL="${{ secrets.ML_SERVICES_URL }}"
          if [ -z "$URL" ]; then echo "‚ùå ML_SERVICES_URL not set"; exit 1; fi
          
          echo "üí∞ Triggering Batch Price Optimization..."
          # Note: In a real system, you'd fetch product IDs first
          # This triggers the internal recommendation logic
          curl -X POST "$URL/pricing/batch-update" \
            -H "Content-Type: application/json" \
            -d '{"products": []}'

  churn-analysis:
    name: Weekly Churn Analysis
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 1 * * 0' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger Customer Churn Prediction
        run: |
          URL="${{ secrets.ML_SERVICES_URL }}"
          if [ -z "$URL" ]; then echo "‚ùå ML_SERVICES_URL not set"; exit 1; fi
          
          echo "üë• Triggering At-Risk Customer Analysis..."
          curl -X GET "$URL/churn/at-risk?minProbability=0.7&limit=100"
