name: Weekly Prophet ML Training

on:
  schedule:
    # Ch·∫°y v√†o 00:00 Ch·ªß Nh·∫≠t h√†ng tu·∫ßn (UTC)
    - cron: '0 0 * * 0'
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ GitHub UI

jobs:
  trigger-training:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Prophet Training on Render
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          # Fallback to production URL if secret not set
          URL="${SITE_URL:-https://smartbuildai.vercel.app}"
          
          echo "üöÄ Triggering ML training at: $URL/api/ml/train"
          
          # Send POST request with --fail to fail on HTTP errors
          response=$(curl -s -f -w "\n%{http_code}" -X POST "$URL/api/ml/train" \
               -H "Content-Type: application/json" \
               -H "x-user-role: MANAGER" \
               -d '{"trainAll": true}') || {
            echo "‚ùå Failed to trigger ML training!"
            echo "Response: $response"
            exit 1
          }
          
          echo "‚úÖ ML training triggered successfully!"
          echo "Response: $response"
